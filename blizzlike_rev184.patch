# HG changeset patch
# User asniker
# Date 1289724523 -18000
# Node ID 24f6d369a4abd6cd78aff64d4f1d92a0a92f6c87
# Parent  63b193a9d6c7eb6a734e7bc1c753b8dc7961f74f
fix pit of saron

diff --git a/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_krickandick.cpp b/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_krickandick.cpp
--- a/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_krickandick.cpp
+++ b/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_krickandick.cpp
@@ -343,19 +343,11 @@
                     }
                     me->SetVisibility(VISIBILITY_ON);
 
-                    Creature* pJainaOrSylvanas = me->GetCreature(*me, pInstance->GetData64(DATA_JAINA_SYLVANAS_1));
-                    if (pJainaOrSylvanas) {
-                        Position pos;
-                        me->GetNearPosition(pos, 5.0f, 0);
-                        pJainaOrSylvanas->NearTeleportTo(pos.GetPositionX(), pos.GetPositionY(), pos.GetPositionZ(),
-                            pos.GetAngle(me->GetPositionX(), me->GetPositionY()));
-                    }
-                    else {
-                        if (pInstance->GetData(DATA_TEAM_IN_INSTANCE) == TEAM_ALLIANCE)
-                            pJainaOrSylvanas = me->SummonCreature(NPC_SYLVANAS_PART1, *me, TEMPSUMMON_MANUAL_DESPAWN);
-                        else
-                            pJainaOrSylvanas = me->SummonCreature(NPC_JAINA_PART1, *me, TEMPSUMMON_MANUAL_DESPAWN);
-                    }
+                    Creature* pJainaOrSylvanas = NULL;
+					if (pInstance->GetData(DATA_TEAM_IN_INSTANCE) == TEAM_ALLIANCE)
+					pJainaOrSylvanas = me->SummonCreature(NPC_JAINA_PART1, *me, TEMPSUMMON_MANUAL_DESPAWN);
+					else
+					pJainaOrSylvanas = me->SummonCreature(NPC_SYLVANAS_PART1, *me, TEMPSUMMON_MANUAL_DESPAWN);
 
                     if (pJainaOrSylvanas)
                     {
@@ -385,7 +377,7 @@
                     case EVENT_OUTRO_1:
                     {
                         DoScriptText(SAY_KRICK_OUTRO_1, me);
-                        events.ScheduleEvent(EVENT_OUTRO_2, 14000);
+                        events.ScheduleEvent(EVENT_OUTRO_2, 7000);
                         break;
                     }
                     case EVENT_OUTRO_2:
@@ -398,12 +390,12 @@
                             else
                                 DoScriptText(SAY_SYLVANAS_OUTRO_2, pNpcDialog);
                         }
-                        events.ScheduleEvent(EVENT_OUTRO_3, 8500);
+                        events.ScheduleEvent(EVENT_OUTRO_3, 7000);
                         break;
                     }
                     case EVENT_OUTRO_3:
                         DoScriptText(SAY_KRICK_OUTRO_3, me);
-                        events.ScheduleEvent(EVENT_OUTRO_4, 12000);
+                        events.ScheduleEvent(EVENT_OUTRO_4, 17000);
                         break;
                     case EVENT_OUTRO_4:
                     {
@@ -420,7 +412,7 @@
                     }
                     case EVENT_OUTRO_5:
                         DoScriptText(SAY_KRICK_OUTRO_5, me);
-                        events.ScheduleEvent(EVENT_OUTRO_6, 4000);
+                        events.ScheduleEvent(EVENT_OUTRO_6, 5000);
                         break;
                     case EVENT_OUTRO_6:
                         // TODO spawn Tyrannus at some distance and MovePoint near-by (flying on rimefang)
diff --git a/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_scourgelord_tyrannus.cpp b/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_scourgelord_tyrannus.cpp
--- a/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_scourgelord_tyrannus.cpp
+++ b/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/boss_scourgelord_tyrannus.cpp
@@ -84,6 +84,8 @@
     SEAT_TYRANNUS = 0
 };
 
+Position SylvanasSpawnPoint = {1056.842f, 116.127f, 628.156f, 0 };
+
 class boss_tyrannus : public CreatureScript
 {
 public:
@@ -147,7 +149,21 @@
                 pInstance->SetData(DATA_TYRANNUS_EVENT, DONE);
                 if (Creature* pRimefang = GetRimefang())
                     pRimefang->ForcedDespawn();
+					
+					Creature* pJainaOrSylvanas = NULL;
+					Position spawnPoint = { 993.056f, 206.891f, 628.156f, 5.059f };
+					if (pInstance->GetData(DATA_TEAM_IN_INSTANCE) == TEAM_ALLIANCE)
+					{
+					if (Creature* pJainaOrSylvanas = me->SummonCreature(NPC_JAINA_PART2, spawnPoint, TEMPSUMMON_MANUAL_DESPAWN))
+					DoScriptText(SAY_JAYNA_OUTRO_4, pJainaOrSylvanas);
+					}
+					 else
+					 {
+					 if (Creature* pJainaOrSylvanas = me->SummonCreature(NPC_SYLVANAS_PART2, spawnPoint, TEMPSUMMON_MANUAL_DESPAWN))
+					 DoScriptText(SAY_SYLVANAS_OUTRO_4, pJainaOrSylvanas);
+					 }
             }
+			me->SummonCreature(NPC_SYLVANAS_PART2,SylvanasSpawnPoint,TEMPSUMMON_DEAD_DESPAWN);
         }
 
         void UpdateAI(const uint32 diff)
diff --git a/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/instance_pit_of_saron.cpp b/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/instance_pit_of_saron.cpp
--- a/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/instance_pit_of_saron.cpp
+++ b/src/server/scripts/Northrend/FrozenHalls/PitOfSaron/instance_pit_of_saron.cpp
@@ -75,14 +75,6 @@
 
         void OnCreatureCreate(Creature* pCreature, bool /*add*/)
         {
-            Map::PlayerList const &players = instance->GetPlayers();
-
-            if (!players.isEmpty())
-            {
-                if (Player* pPlayer = players.begin()->getSource())
-                    uiTeamInInstance = pPlayer->GetTeam();
-            }
-
             switch(pCreature->GetEntry())
             {
                 case CREATURE_KRICK:
@@ -137,18 +129,18 @@
                     break;
             }
          }
-		
-		void OnGameObjectCreate(GameObject* pGo, bool add)
-		{
-			if (!add)
-				return;
-			switch(pGo->GetEntry())
-			{
-			case GO_ICE_WALL:
-				uiIceWall = pGo->GetGUID();
-				HandleGameObject(0, false, pGo);
-				break;
-			}
+		 
+		 void OnGameObjectCreate(GameObject* pGo, bool add)
+		 {
+		 if (!add)
+		 return;
+		 switch(pGo->GetEntry())
+		 {
+		 case GO_ICE_WALL:
+		 uiIceWall = pGo->GetGUID();
+		 HandleGameObject(0, false, pGo);
+		 break;
+		 }
 		}
 
         uint64 GetData64(uint32 identifier)
@@ -179,7 +171,7 @@
                     uiEncounter[1] = data;
                     break;
                case DATA_KRICKANDICK_EVENT:
-					uiEncounter[2] = data;
+			          uiEncounter[2] = data;
 					if(data == DONE)
 					HandleGameObject(uiIceWall, true);
                     break;
@@ -196,6 +188,7 @@
                 case DATA_GARFROST_EVENT:            return uiEncounter[0];
                 case DATA_TYRANNUS_EVENT:            return uiEncounter[1];
                 case DATA_KRICKANDICK_EVENT:         return uiEncounter[2];
+				case DATA_TEAM_IN_INSTANCE:          return uiTeamInInstance;
             }
 
             return 0;
@@ -215,6 +208,11 @@
             OUT_SAVE_INST_DATA_COMPLETE;
             return str_data;
         }
+		
+		void OnPlayerEnter(Player *m_player)
+		{
+		uiTeamInInstance = m_player->GetTeamId();
+		}
 
         void Load(const char* in)
         {
