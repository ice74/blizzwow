# HG changeset patch
# User asniker
# Date 1290251573 -18000
# Node ID 07d20c3dc026c00fe5511fc606a6c661d28f28ae
# Parent  55d4152369e8e59d2cf0bd6659db9d88cae32224
ядро: фикс дамага, фикс ресайленса

diff --git a/src/server/game/Entities/Unit/Unit.cpp b/src/server/game/Entities/Unit/Unit.cpp
--- a/src/server/game/Entities/Unit/Unit.cpp
+++ b/src/server/game/Entities/Unit/Unit.cpp
@@ -1041,50 +1041,23 @@
                     damage -= damageInfo->blocked;
                 }
 
-				// Reduce damage from resilience for players and pets only.
-				// As of patch 3.3 pets inherit 100% of master resilience.
-				if (GetSpellModOwner())
-					if (Player* modOwner = pVictim->GetSpellModOwner())
-					{
-						if (crit)
-						{
-							if (attackType != RANGED_ATTACK)
-								damage -= modOwner->GetMeleeCritDamageReduction(damage);
-							else
-								damage -= modOwner->GetRangedCritDamageReduction(damage);
-						}
-						if (attackType != RANGED_ATTACK)
-							damage -= modOwner->GetMeleeDamageReduction(damage);
-						else
-							 damage -= modOwner->GetRangedDamageReduction(damage);
-					}
                 if (attackType != RANGED_ATTACK)
                     ApplyResilience(pVictim, NULL, &damage, crit, CR_CRIT_TAKEN_MELEE);
                 else
                     ApplyResilience(pVictim, NULL, &damage, crit, CR_CRIT_TAKEN_RANGED);
             }
+			break;
         // Magical Attacks
         case SPELL_DAMAGE_CLASS_NONE:
         case SPELL_DAMAGE_CLASS_MAGIC:
             {
-
                 // If crit add critical bonus
                 if (crit)
                 {
                     damageInfo->HitInfo |= SPELL_HIT_TYPE_CRIT;
                     damage = SpellCriticalDamageBonus(spellInfo, damage, pVictim);
                 }
-				{
-					// Reduce damage from resilience for players and pets only.
-					// As of patch 3.3 pets inherit 100% of master resilience.
-					if (GetSpellModOwner())
-						if (Player* modOwner = pVictim->GetSpellModOwner())
-						{
-							if (crit)
-								damage -= modOwner->GetSpellCritDamageReduction(damage);
-							damage -= modOwner->GetSpellDamageReduction(damage);
-						}
-				}
+
                 ApplyResilience(pVictim, NULL, &damage, crit, CR_CRIT_TAKEN_SPELL);
             }
             break;
@@ -1255,22 +1228,7 @@
                 // Increase crit damage from SPELL_AURA_MOD_CRIT_PERCENT_VERSUS
                 mod += GetTotalAuraModifierByMiscMask(SPELL_AURA_MOD_CRIT_PERCENT_VERSUS, crTypeMask);
                 if (mod != 0)
-                    damageInfo->damage = int32((damageInfo->damage) * float((100.0f + mod)/100.0f));
-
-				// Reduce damage from resilience for players and pets only.
-				// As of patch 3.3 pets inherit 100% of master resilience.
-				if (GetSpellModOwner())
-					 if (Player* modOwner = pVictim->GetSpellModOwner())
-					 {
-						 uint32 resilienceReduction;
-						 if (attackType != RANGED_ATTACK)
-							 resilienceReduction = modOwner->GetMeleeCritDamageReduction(damageInfo->damage);
-						 else
-							 resilienceReduction = modOwner->GetRangedCritDamageReduction(damageInfo->damage);
-
-						 damageInfo->damage      -= resilienceReduction;
-						 damageInfo->cleanDamage += resilienceReduction;
-					 }
+                    damageInfo->damage = int32((damageInfo->damage) * float((100.0f + mod)/100.0f));					
 			}
             break;
         case MELEE_HIT_PARRY:
@@ -1340,22 +1298,7 @@
     resilienceReduction = damageInfo->damage - resilienceReduction;
     damageInfo->damage      -= resilienceReduction;
     damageInfo->cleanDamage += resilienceReduction;
-
-    // Reduce damage from resilience for players and pets only.
-	// As of patch 3.3 pets inherit 100% of master resilience.
-	if (GetSpellModOwner())
-		if (Player* modOwner = pVictim->GetSpellModOwner())
-		{
-			uint32 resilienceReduction;
-			if (attackType != RANGED_ATTACK)
-				resilienceReduction = modOwner->GetMeleeDamageReduction(damageInfo->damage);
-			else
-				resilienceReduction = modOwner->GetRangedDamageReduction(damageInfo->damage);
-
-			damageInfo->damage      -= resilienceReduction;
-			damageInfo->cleanDamage += resilienceReduction;
-		}
-
+ 
     // Calculate absorb resist
     if (int32(damageInfo->damage) > 0)
     {
@@ -3106,37 +3049,25 @@
         crit += GetTotalAuraModifier(SPELL_AURA_MOD_CRIT_PCT);
     }
 
-    // flat aura mods
+      // flat aura mods
     if (attackType == RANGED_ATTACK)
         crit += pVictim->GetTotalAuraModifier(SPELL_AURA_MOD_ATTACKER_RANGED_CRIT_CHANCE);
     else
         crit += pVictim->GetTotalAuraModifier(SPELL_AURA_MOD_ATTACKER_MELEE_CRIT_CHANCE);
 
-    crit += pVictim->GetTotalAuraModifier(SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE);
-
-    // reduce crit chance from Rating for players
+    crit += pVictim->GetMaxPositiveAuraModifier(SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE);
+    crit += pVictim->GetMaxNegativeAuraModifier(SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE);
+
+     // reduce crit chance from Rating for players
     if (attackType != RANGED_ATTACK)
     {
-		 // Reduce crit chance from resilience for players and pets only.
-	// As of patch 3.3 pets inherit 100% of master resilience.
-		{
-			if (GetSpellModOwner())
-		if (Player* modOwner = pVictim->GetSpellModOwner())
-			crit -= modOwner->GetMeleeCritChanceReduction();
         ApplyResilience(pVictim, &crit, NULL, false, CR_CRIT_TAKEN_MELEE);
-
         // Glyph of barkskin
         if (pVictim->HasAura(63057) && pVictim->HasAura(22812))
             crit -= 25.0f;
-
-    	 else if (GetSpellModOwner())
-		 if (Player* modOwner = pVictim->GetSpellModOwner())
-			 crit -= modOwner->GetRangedCritChanceReduction();
-    }
-	}
+    }
     else
         ApplyResilience(pVictim, &crit, NULL, false, CR_CRIT_TAKEN_RANGED);
-
 	
     // Apply crit chance from defence skill
     crit += (int32(GetMaxSkillValueForLevel(pVictim)) - int32(pVictim->GetDefenseSkillValue(this))) * 0.04f;
@@ -11002,16 +10933,10 @@
                     // Modify critical chance by victim SPELL_AURA_MOD_ATTACKER_SPELL_CRIT_CHANCE
                     crit_chance += pVictim->GetTotalAuraModifierByMiscMask(SPELL_AURA_MOD_ATTACKER_SPELL_CRIT_CHANCE, schoolMask);
                     // Modify critical chance by victim SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE
-                    crit_chance += pVictim->GetTotalAuraModifier(SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE);
-					ApplyResilience(pVictim, &crit_chance, NULL, false, CR_CRIT_TAKEN_SPELL);
-                }
-
-				// Reduce crit chance from resilience for players and pets only.
-				// As of patch 3.3 pets inherit 100% of master resilience.
-				if (GetSpellModOwner())
-					if (Player* modOwner = pVictim->GetSpellModOwner())
-						crit_chance -= modOwner->GetSpellCritChanceReduction();
-      				
+                    crit_chance += pVictim->GetMaxPositiveAuraModifier(SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE);
+                    crit_chance += pVictim->GetMaxNegativeAuraModifier(SPELL_AURA_MOD_ATTACKER_SPELL_AND_WEAPON_CRIT_CHANCE);
+                    ApplyResilience(pVictim, &crit_chance, NULL, false, CR_CRIT_TAKEN_SPELL);
+                }	
                 // scripted (increase crit chance ... against ... target by x%
                 AuraEffectList const& mOverrideClassScript = GetAuraEffectsByType(SPELL_AURA_OVERRIDE_CLASS_SCRIPTS);
                 for (AuraEffectList::const_iterator i = mOverrideClassScript.begin(); i != mOverrideClassScript.end(); ++i)
diff --git a/src/server/game/Spells/Auras/SpellAuraEffects.cpp b/src/server/game/Spells/Auras/SpellAuraEffects.cpp
--- a/src/server/game/Spells/Auras/SpellAuraEffects.cpp
+++ b/src/server/game/Spells/Auras/SpellAuraEffects.cpp
@@ -1288,17 +1288,7 @@
                     cleanDamage.mitigated_damage += damage - damageReductedArmor;
                     damage = damageReductedArmor;
                 }
-
-				// Reduce damage from resilience for players and pets only.
-			// As of patch 3.3 pets inherit 100% of master resilience.
-			 if (caster->GetSpellModOwner())
-				 if (Player* modOwner = target->GetSpellModOwner())
-				 {
-					 if (CR_CRIT_TAKEN_SPELL)
-						 damage -= modOwner->GetSpellCritDamageReduction(damage);
-					 damage -= modOwner->GetSpellDamageReduction(damage);
-				 }
-                
+				
                 // Curse of Agony damage-per-tick calculation
                 if (GetSpellProto()->SpellFamilyName == SPELLFAMILY_WARLOCK && (GetSpellProto()->SpellFamilyFlags[0] & 0x400) && GetSpellProto()->SpellIconID == 544)
                 {
