# HG changeset patch
# User asniker
# Date 1290423174 -18000
# Node ID f25e89b743c0929be49acd855848011250171ac8
# Parent  ea7d60e5d5b2df2b68ffef52096e43ef7708ef04
ßäðî: ôèêñ forst fingers (ìàã)

diff --git a/sql/Blizzlike@Sacred-core/Full sql and scripts/3) FULL sql.sql b/sql/Blizzlike@Sacred-core/Full sql and scripts/3) FULL sql.sql
--- a/sql/Blizzlike@Sacred-core/Full sql and scripts/3) FULL sql.sql	
+++ b/sql/Blizzlike@Sacred-core/Full sql and scripts/3) FULL sql.sql	
@@ -5728,24 +5728,25 @@
 
 
 
-
-DELETE FROM `spell_proc_event` WHERE `entry` IN ('44544','74396');
-DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (44544,-44544);
-
 DELETE FROM `spell_dbc` WHERE `Id` IN ('199998');
 INSERT INTO `spell_dbc` (`Id`, `Dispel`, `Mechanic`, `Attributes`, `AttributesEx`, `AttributesEx2`, `AttributesEx3`, `AttributesEx4`, `AttributesEx5`, `Stances`, `StancesNot`, `Targets`, `CastingTimeIndex`, `AuraInterruptFlags`, `ProcFlags`, `ProcChance`, `ProcCharges`, `MaxLevel`, `BaseLevel`, `SpellLevel`, `DurationIndex`, `RangeIndex`, `StackAmount`, `EquippedItemClass`, `EquippedItemSubClassMask`, `EquippedItemInventoryTypeMask`, `Effect1`, `Effect2`, `Effect3`, `EffectDieSides1`, `EffectDieSides2`, `EffectDieSides3`, `EffectRealPointsPerLevel1`, `EffectRealPointsPerLevel2`, `EffectRealPointsPerLevel3`, `EffectBasePoints1`, `EffectBasePoints2`, `EffectBasePoints3`, `EffectMechanic1`, `EffectMechanic2`, `EffectMechanic3`, `EffectImplicitTargetA1`, `EffectImplicitTargetA2`, `EffectImplicitTargetA3`, `EffectImplicitTargetB1`, `EffectImplicitTargetB2`, `EffectImplicitTargetB3`, `EffectRadiusIndex1`, `EffectRadiusIndex2`, `EffectRadiusIndex3`, `EffectApplyAuraName1`, `EffectApplyAuraName2`, `EffectApplyAuraName3`, `EffectAmplitude1`, `EffectAmplitude2`, `EffectAmplitude3`, `EffectMultipleValue1`, `EffectMultipleValue2`, `EffectMultipleValue3`, `EffectMiscValue1`, `EffectMiscValue2`, `EffectMiscValue3`, `EffectMiscValueB1`, `EffectMiscValueB2`, `EffectMiscValueB3`, `EffectTriggerSpell1`, `EffectTriggerSpell2`, `EffectTriggerSpell3`, `EffectSpellClassMaskA1`, `EffectSpellClassMaskA2`, `EffectSpellClassMaskA3`, `EffectSpellClassMaskB1`, `EffectSpellClassMaskB2`, `EffectSpellClassMaskB3`, `EffectSpellClassMaskC1`, `EffectSpellClassMaskC2`, `EffectSpellClassMaskC3`, `MaxTargetLevel`, `SpellFamilyName`, `SpellFamilyFlags1`, `SpellFamilyFlags2`, `SpellFamilyFlags3`, `MaxAffectedTargets`, `DmgClass`, `PreventionType`, `DmgMultiplier1`, `DmgMultiplier2`, `DmgMultiplier3`, `AreaGroupId`, `SchoolMask`, `Comment`) VALUES
 ('199998','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','1','0','-1','0','0','3','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','3','0','0','0','0','0','0','0','0','0','0','0','Frostbite Helper (SERVERSIDE)');
 
-
+DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (44544,-44544);
 DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (12494);
 INSERT INTO `spell_linked_spell` (`spell_trigger`, `spell_effect`, `type`, `comment`) VALUES
 ('12494','199998','0','Frostbite');
 
+DELETE FROM `spell_proc_event` WHERE `entry` IN ('44544','74396');
 DELETE FROM `spell_proc_event` WHERE `entry` IN ('44543', '44545');
 INSERT INTO `spell_proc_event` (`entry`, `SchoolMask`, `SpellFamilyName`, `SpellFamilyMask0`, `SpellFamilyMask1`, `SpellFamilyMask2`, `procFlags`, `procEx`, `ppmRate`, `CustomChance`, `Cooldown`) VALUES
 ('44543','0','3','1049120','4096','0','65536','0','0','0','0'),
+('44544','0','3','685904631','1151048','0','65536','0','0','0','0'),
 ('44545','0','3','1049120','4096','0','65536','0','0','0','0');
 
+
+
+
 UPDATE `creature_template` SET `dynamicflags` = '8' WHERE `entry` = '37970';
 UPDATE `creature_template` SET `dynamicflags` = '8' WHERE `entry` = '37972';
 UPDATE `creature_template` SET `dynamicflags` = '8' WHERE `entry` = '37973';
diff --git a/sql/Blizzlike@Sacred-core/new fix/fix frost fingers.sql b/sql/Blizzlike@Sacred-core/new fix/fix frost fingers.sql
new file mode 100644
--- /dev/null
+++ b/sql/Blizzlike@Sacred-core/new fix/fix frost fingers.sql	
@@ -0,0 +1,16 @@
+ï»¿DELETE FROM `spell_dbc` WHERE `Id` IN ('199998');
+INSERT INTO `spell_dbc` (`Id`, `Dispel`, `Mechanic`, `Attributes`, `AttributesEx`, `AttributesEx2`, `AttributesEx3`, `AttributesEx4`, `AttributesEx5`, `Stances`, `StancesNot`, `Targets`, `CastingTimeIndex`, `AuraInterruptFlags`, `ProcFlags`, `ProcChance`, `ProcCharges`, `MaxLevel`, `BaseLevel`, `SpellLevel`, `DurationIndex`, `RangeIndex`, `StackAmount`, `EquippedItemClass`, `EquippedItemSubClassMask`, `EquippedItemInventoryTypeMask`, `Effect1`, `Effect2`, `Effect3`, `EffectDieSides1`, `EffectDieSides2`, `EffectDieSides3`, `EffectRealPointsPerLevel1`, `EffectRealPointsPerLevel2`, `EffectRealPointsPerLevel3`, `EffectBasePoints1`, `EffectBasePoints2`, `EffectBasePoints3`, `EffectMechanic1`, `EffectMechanic2`, `EffectMechanic3`, `EffectImplicitTargetA1`, `EffectImplicitTargetA2`, `EffectImplicitTargetA3`, `EffectImplicitTargetB1`, `EffectImplicitTargetB2`, `EffectImplicitTargetB3`, `EffectRadiusIndex1`, `EffectRadiusIndex2`, `EffectRadiusIndex3`, `EffectApplyAuraName1`, `EffectApplyAuraName2`, `EffectApplyAuraName3`, `EffectAmplitude1`, `EffectAmplitude2`, `EffectAmplitude3`, `EffectMultipleValue1`, `EffectMultipleValue2`, `EffectMultipleValue3`, `EffectMiscValue1`, `EffectMiscValue2`, `EffectMiscValue3`, `EffectMiscValueB1`, `EffectMiscValueB2`, `EffectMiscValueB3`, `EffectTriggerSpell1`, `EffectTriggerSpell2`, `EffectTriggerSpell3`, `EffectSpellClassMaskA1`, `EffectSpellClassMaskA2`, `EffectSpellClassMaskA3`, `EffectSpellClassMaskB1`, `EffectSpellClassMaskB2`, `EffectSpellClassMaskB3`, `EffectSpellClassMaskC1`, `EffectSpellClassMaskC2`, `EffectSpellClassMaskC3`, `MaxTargetLevel`, `SpellFamilyName`, `SpellFamilyFlags1`, `SpellFamilyFlags2`, `SpellFamilyFlags3`, `MaxAffectedTargets`, `DmgClass`, `PreventionType`, `DmgMultiplier1`, `DmgMultiplier2`, `DmgMultiplier3`, `AreaGroupId`, `SchoolMask`, `Comment`) VALUES
+('199998','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','1','0','-1','0','0','3','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','3','0','0','0','0','0','0','0','0','0','0','0','Frostbite Helper (SERVERSIDE)');
+
+DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (44544,-44544);
+DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (12494);
+INSERT INTO `spell_linked_spell` (`spell_trigger`, `spell_effect`, `type`, `comment`) VALUES
+('12494','199998','0','Frostbite');
+
+DELETE FROM `spell_proc_event` WHERE `entry` IN ('44544','74396');
+DELETE FROM `spell_proc_event` WHERE `entry` IN ('44543', '44545');
+INSERT INTO `spell_proc_event` (`entry`, `SchoolMask`, `SpellFamilyName`, `SpellFamilyMask0`, `SpellFamilyMask1`, `SpellFamilyMask2`, `procFlags`, `procEx`, `ppmRate`, `CustomChance`, `Cooldown`) VALUES
+('44543','0','3','1049120','4096','0','65536','0','0','0','0'),
+('44544','0','3','685904631','1151048','0','65536','0','0','0','0'),
+('44545','0','3','1049120','4096','0','65536','0','0','0','0');
+
diff --git a/sql/Blizzlike@Sacred-core/new fix/old/fix frost fingers.sql b/sql/Blizzlike@Sacred-core/new fix/old/fix frost fingers.sql
--- a/sql/Blizzlike@Sacred-core/new fix/old/fix frost fingers.sql	
+++ b/sql/Blizzlike@Sacred-core/new fix/old/fix frost fingers.sql	
@@ -1,16 +1,16 @@
-ï»¿DELETE FROM `spell_proc_event` WHERE `entry` IN ('44544','74396');
-DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (44544,-44544);
-
-DELETE FROM `spell_dbc` WHERE `Id` IN ('199998');
+ï»¿DELETE FROM `spell_dbc` WHERE `Id` IN ('199998');
 INSERT INTO `spell_dbc` (`Id`, `Dispel`, `Mechanic`, `Attributes`, `AttributesEx`, `AttributesEx2`, `AttributesEx3`, `AttributesEx4`, `AttributesEx5`, `Stances`, `StancesNot`, `Targets`, `CastingTimeIndex`, `AuraInterruptFlags`, `ProcFlags`, `ProcChance`, `ProcCharges`, `MaxLevel`, `BaseLevel`, `SpellLevel`, `DurationIndex`, `RangeIndex`, `StackAmount`, `EquippedItemClass`, `EquippedItemSubClassMask`, `EquippedItemInventoryTypeMask`, `Effect1`, `Effect2`, `Effect3`, `EffectDieSides1`, `EffectDieSides2`, `EffectDieSides3`, `EffectRealPointsPerLevel1`, `EffectRealPointsPerLevel2`, `EffectRealPointsPerLevel3`, `EffectBasePoints1`, `EffectBasePoints2`, `EffectBasePoints3`, `EffectMechanic1`, `EffectMechanic2`, `EffectMechanic3`, `EffectImplicitTargetA1`, `EffectImplicitTargetA2`, `EffectImplicitTargetA3`, `EffectImplicitTargetB1`, `EffectImplicitTargetB2`, `EffectImplicitTargetB3`, `EffectRadiusIndex1`, `EffectRadiusIndex2`, `EffectRadiusIndex3`, `EffectApplyAuraName1`, `EffectApplyAuraName2`, `EffectApplyAuraName3`, `EffectAmplitude1`, `EffectAmplitude2`, `EffectAmplitude3`, `EffectMultipleValue1`, `EffectMultipleValue2`, `EffectMultipleValue3`, `EffectMiscValue1`, `EffectMiscValue2`, `EffectMiscValue3`, `EffectMiscValueB1`, `EffectMiscValueB2`, `EffectMiscValueB3`, `EffectTriggerSpell1`, `EffectTriggerSpell2`, `EffectTriggerSpell3`, `EffectSpellClassMaskA1`, `EffectSpellClassMaskA2`, `EffectSpellClassMaskA3`, `EffectSpellClassMaskB1`, `EffectSpellClassMaskB2`, `EffectSpellClassMaskB3`, `EffectSpellClassMaskC1`, `EffectSpellClassMaskC2`, `EffectSpellClassMaskC3`, `MaxTargetLevel`, `SpellFamilyName`, `SpellFamilyFlags1`, `SpellFamilyFlags2`, `SpellFamilyFlags3`, `MaxAffectedTargets`, `DmgClass`, `PreventionType`, `DmgMultiplier1`, `DmgMultiplier2`, `DmgMultiplier3`, `AreaGroupId`, `SchoolMask`, `Comment`) VALUES
 ('199998','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','1','0','-1','0','0','3','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','3','0','0','0','0','0','0','0','0','0','0','0','Frostbite Helper (SERVERSIDE)');
 
-
+DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (44544,-44544);
 DELETE FROM `spell_linked_spell` WHERE `spell_trigger` in (12494);
 INSERT INTO `spell_linked_spell` (`spell_trigger`, `spell_effect`, `type`, `comment`) VALUES
 ('12494','199998','0','Frostbite');
 
+DELETE FROM `spell_proc_event` WHERE `entry` IN ('44544','74396');
 DELETE FROM `spell_proc_event` WHERE `entry` IN ('44543', '44545');
 INSERT INTO `spell_proc_event` (`entry`, `SchoolMask`, `SpellFamilyName`, `SpellFamilyMask0`, `SpellFamilyMask1`, `SpellFamilyMask2`, `procFlags`, `procEx`, `ppmRate`, `CustomChance`, `Cooldown`) VALUES
 ('44543','0','3','1049120','4096','0','65536','0','0','0','0'),
-('44545','0','3','1049120','4096','0','65536','0','0','0','0');
\ No newline at end of file
+('44544','0','3','685904631','1151048','0','65536','0','0','0','0'),
+('44545','0','3','1049120','4096','0','65536','0','0','0','0');
+
diff --git a/src/server/game/Entities/Unit/Unit.cpp b/src/server/game/Entities/Unit/Unit.cpp
--- a/src/server/game/Entities/Unit/Unit.cpp
+++ b/src/server/game/Entities/Unit/Unit.cpp
@@ -8179,6 +8179,19 @@
                     this->CastCustomSpell(this, 67545, &bp0, NULL, NULL, true, NULL, triggeredByAura->GetEffect(0), this->GetGUID());
                     return true;
                 }
+				case 44544: // Fingers of Frost
+                {
+                    *handled = true;
+
+                    int32 key = int32(uint32(uint32(triggeredByAura->GetApplyTime()) & uint32(0x7FFFFFFF)));
+
+                    if (Aura * aura = GetAura(74396))
+                        if (aura->GetEffect(EFFECT_0)->GetAmount() == key)
+                            if (aura->DropCharge())
+                                triggeredByAura->Remove();
+
+                    return false;
+                }
             }
             break;
         }
diff --git a/src/server/game/Spells/Auras/SpellAuras.cpp b/src/server/game/Spells/Auras/SpellAuras.cpp
--- a/src/server/game/Spells/Auras/SpellAuras.cpp
+++ b/src/server/game/Spells/Auras/SpellAuras.cpp
@@ -976,19 +976,7 @@
                             if (spellId)
                                 caster->CastSpell(caster, spellId, true);
                         }
-                        break;
-                    case 44544: // Fingers of Frost
-                    {
-                        // See if we already have the indicator aura. If not, create one.
-                        if (Aura *aur = target->GetAura(74396))
-                        {
-                            // Aura already there. Refresh duration and set original charges
-                            aur->SetCharges(2);
-                            aur->RefreshDuration();
-                        }
-                        else
-                            target->AddAura(74396, target);
-                    }
+                        break;                   
                     default:
                         break;
                 }
@@ -1160,9 +1148,11 @@
                         target->CastSpell(target, 32612, true, NULL, GetEffect(1));
                         break;
                     case 74396: // Fingers of Frost
-                        // Remove the IGNORE_AURASTATE aura
-                        target->RemoveAurasDueToSpell(44544);
+                        {
+                        if (removeMode == AURA_REMOVE_BY_CANCEL)
+                            target->RemoveAurasDueToSpell(44544);
                         break;
+						}
                     case 44401: //Missile Barrage
                     case 48108: //Hot Streak
                     case 57761: //Fireball!
@@ -1622,6 +1612,43 @@
                 }
             }
             break;
+			case SPELLFAMILY_MAGE:
+            switch(GetSpellProto()->Id)
+            {
+                case 44544: // Fingers of Frost
+                {
+                    int32 key = int32(uint32(uint32(aurApp->GetBase()->GetApplyTime()) & uint32(0x7FFFFFFF)));
+
+                    // See if we already have the indicator aura. If not, create one.
+                    if (Aura * aura = target->GetAura(74396))
+                    {
+                        if (!apply)
+                        {
+                            if (aura->GetEffect(EFFECT_0)->GetAmount() == key)
+                                aura->Remove(removeMode);
+                            break;
+                        }
+
+                        // Aura already there. Refresh duration and set original charges
+                        aura->SetCharges(aurApp->GetBase()->GetEffect(EFFECT_0)->GetAmount());
+                        aura->GetEffect(EFFECT_0)->SetAmount(key);
+                        aura->RefreshDuration();
+                        break;
+                    }
+                    else if (apply)
+                        if (Aura * aura = target->AddAura(74396, target))
+                        {
+                            aura->GetEffect(EFFECT_0)->SetAmount(key);
+                            aura->SetCharges(aurApp->GetBase()->GetEffect(EFFECT_0)->GetAmount());
+                        }
+                    break;
+                }
+                default:
+                    break;
+            }
+            break;
+        default:
+            break;
     }
 }
 
diff --git a/src/server/game/Spells/SpellMgr.cpp b/src/server/game/Spells/SpellMgr.cpp
--- a/src/server/game/Spells/SpellMgr.cpp
+++ b/src/server/game/Spells/SpellMgr.cpp
@@ -3847,8 +3847,7 @@
             spellInfo->EffectSpellClassMask[0] = flag96(685904631, 1151048, 0);
             count++;
             break;
-        case 74396:    // Fingers of Frost visual buff
-            spellInfo->procCharges = 2;
+        case 74396:    // Fingers of Frost visual buff            
             spellInfo->StackAmount = 0;
             count++;
             break;
