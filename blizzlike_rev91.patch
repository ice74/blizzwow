# HG changeset patch
# User asniker
# Date 1288537334 -18000
# Node ID 460a6f6d99ed6b6973718204916052a6907753e8
# Parent  fbdbf66b64d6f04d3a30a941056d38534dfd6b16
fix icecrown citadel

diff --git a/sql/Greedy-core/world/IcecrownCitadel.sql b/sql/Greedy-core/world/IcecrownCitadel.sql
--- a/sql/Greedy-core/world/IcecrownCitadel.sql
+++ b/sql/Greedy-core/world/IcecrownCitadel.sql
@@ -13,7 +13,7 @@
 UPDATE gameobject SET phaseMask = 17 WHERE id IN (201375,201374);
 
 -- Test platform destruction
-UPDATE `gameobject_template` SET `flags` = 544 WHERE `entry` = 202161;
+UPDATE `gameobject_template` SET `flags` = 32 WHERE `entry` = 202161;
 UPDATE `gameobject` SET `state` = '1' WHERE `id` IN (202161);
 
 
@@ -39,10 +39,7 @@
 UPDATE `creature_template` SET `ScriptName`='npc_cold_flame' WHERE `entry` = 36672;
 UPDATE `creature_template` SET `ScriptName`='npc_bone_spike' WHERE `entry` = 36619;
 UPDATE `creature_template` SET `ScriptName`='npc_volatile_ooze' WHERE `entry` = 37697;
-UPDATE `creature_template` SET `ScriptName`='npc_ice_puls_icc' WHERE `entry` = 36633;
 UPDATE `creature_template` SET `ScriptName`='npc_valkyr_icc' WHERE `entry` = 36609;
-UPDATE `creature_template` SET `ScriptName`='npc_ghoul_icc' WHERE `entry` = 37695;
-UPDATE `creature_template` SET `ScriptName`='npc_defile_icc' WHERE `entry` = 38757;
 UPDATE `creature_template` SET `ScriptName`='npc_vile_spirit_icc' WHERE `entry`= 37799;
 UPDATE `creature_template` SET `ScriptName`='npc_ooze_little' WHERE `entry`= 36897;
 UPDATE `creature_template` SET `ScriptName`='npc_ooze_big' WHERE `entry`= 36899;
@@ -81,7 +78,7 @@
 UPDATE `creature_template` SET `spell1` = 72527, `spell2`= 72457, `spell3`= 70542, `VehicleId` = 591 WHERE `entry`= 38285;
 UPDATE `creature_template` SET `dynamicflags` = 8, `npcflag` = 0, `unit_flags` = 32832 WHERE `entry` = 38995;
 UPDATE `creature_template` SET `faction_A` = 14, `faction_H` = 14 WHERE `entry` IN (36899,38123);
-UPDATE `creature_template` SET `MovementType` = 1 WHERE `entry` = 37985;
+UPDATE `creature_template` SET `MovementType` = 1 WHERE `entry` IN(37985,37799,39284,39285,39286);
 
 -- Spell
 
@@ -89,7 +86,7 @@
 
 -- Not attackable and disable move flag
 	
-UPDATE `creature_template` SET `unit_flags` = 33555204 WHERE `entry` IN (37986,37824,38234,38317,36659,38548,37186,37006,37918,37690,38068);
+UPDATE `creature_template` SET `unit_flags` = 33555204 WHERE `entry` IN (37986,37824,38234,38317,36659,38548,37186,37006,37918,37690,38068,27880);
 UPDATE `creature_template` SET `unit_flags` = 33587972 WHERE `entry` = 37013;
 UPDATE `creature_template` SET `flags_extra` = 0 WHERE `entry` IN (37986,38234,38317,36659,38548,37186,37013);
 UPDATE `creature_template` SET `flags_extra` = 128 WHERE `entry` = 38234;
@@ -119,7 +116,7 @@
 
 -- Conditions
 
-DELETE FROM `conditions` WHERE `SourceEntry` IN (69508,70881,70360,36659,70781,70856,70857,70858,70859,70860,70861,69157,71614);
+DELETE FROM `conditions` WHERE `SourceEntry` IN (69508,70881,70360,36659,70781,70856,70857,70858,70859,70860,70861,69157,71614,70588);
 DELETE FROM `conditions` WHERE `ConditionValue2` IN (SELECT `id` FROM `creature` WHERE `map` = 631);
 
 INSERT INTO `conditions` (`SourceTypeOrReferenceId`,`SourceGroup`,`SourceEntry`,`ElseGroup`,`ConditionTypeOrReference`,`ConditionValue1`,`ConditionValue2`,`ConditionValue3`,`ErrorTextId`,`ScriptName`,`Comment`) VALUES
@@ -152,7 +149,7 @@
 
 -- Linked spell
 
-DELETE FROM `spell_linked_spell` WHERE `spell_trigger` = 72202;
+DELETE FROM `spell_linked_spell` WHERE `spell_trigger` IN (72202,70117);
 DELETE FROM `spell_linked_spell` WHERE `spell_effect` IN(72202,69166,70347,72380,69706,70702,70311, 69291);
 INSERT INTO `spell_linked_spell` (`spell_trigger`,`spell_effect`,`type`,`comment`) VALUES
 (70360,70347,0,'Eat Ooze'),
@@ -208,6 +205,16 @@
 DELETE FROM `spell_script_names` WHERE `spell_id` IN (70541,73779,73780,73781) AND `ScriptName`='spell_lich_king_infection';
 DELETE FROM `spell_script_names` WHERE `spell_id` IN (73781,73785,73786,73787) AND `ScriptName`='spell_lich_king_necrotic_plague';
 DELETE FROM `spell_script_names` WHERE `spell_id` IN (69075,70834,70835,70836) AND `ScriptName`='spell_lord_marrowgar_bone_storm';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (70157) AND `ScriptName`='spell_sindragosa_ice_tomb';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (70127,72528,72529,72530) AND `ScriptName`='spell_sindragosa_mystic_buffet';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (69766) AND `ScriptName`='spell_sindragosa_unchained_magic';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (72219,72551,72552,72553) AND `ScriptName`='spell_festergut_gastric_bloat';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (69558) AND `ScriptName`='spell_rotface_unstable_explosion';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (68981,74270,74271,74272) AND `ScriptName`='spell_lich_king_winter';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (70534) AND `ScriptName`='spell_vile_spirit_distance_check';
+DELETE FROM `spell_script_names` WHERE `spell_id` IN (69110) AND `ScriptName`='spell_ice_burst_distance_check';
+
+
 
 INSERT INTO `spell_script_names` (`spell_id`, `ScriptName`) VALUES
 (71412,'spell_putricide_ooze_summon'),
@@ -219,7 +226,6 @@
 (70308,'spell_putricide_mutation_init'),
 (70311,'spell_putricide_mutated_transformation'),
 (71503,'spell_putricide_mutated_transformation'),
-(72262,'spell_lich_king_quake'),
 (74361,'spell_lich_king_valkyr_summon'),
 (70541,'spell_lich_king_infection'),
 (73779,'spell_lich_king_infection'),
@@ -232,11 +238,32 @@
 (69075,'spell_lord_marrowgar_bone_storm'),
 (70834,'spell_lord_marrowgar_bone_storm'),
 (70835,'spell_lord_marrowgar_bone_storm'),
-(70836,'spell_lord_marrowgar_bone_storm');
+(70836,'spell_lord_marrowgar_bone_storm'),
+(70157,'spell_sindragosa_ice_tomb'),
+(70127,'spell_sindragosa_mystic_buffet'),
+(72528,'spell_sindragosa_mystic_buffet'),
+(72529,'spell_sindragosa_mystic_buffet'),
+(72530,'spell_sindragosa_mystic_buffet'),
+(69766,'spell_sindragosa_unchained_magic'),
+(72219,'spell_festergut_gastric_bloat'),
+(72551,'spell_festergut_gastric_bloat'),
+(72552,'spell_festergut_gastric_bloat'),
+(72553,'spell_festergut_gastric_bloat'),
+(69558,'spell_rotface_unstable_explosion'),
+(68981,'spell_lich_king_winter'),
+(74270,'spell_lich_king_winter'),
+(74271,'spell_lich_king_winter'),
+(74272,'spell_lich_king_winter'),
+(70534,'spell_vile_spirit_distance_check'),
+(69110,'spell_ice_burst_distance_check'),
+(72262,'spell_lich_king_quake');
 
+-- ***_scripts table
 
 UPDATE waypoint_scripts SET delay = 3 WHERE dataint = 38879 AND command = 15;
-
+DELETE FROM `spell_scripts` WHERE id = 72429 AND command = 15;
+INSERT INTO `spell_scripts` VALUE
+('72429','0','3','15','72423','0','0','0','0','0','0');
 
 -- Event AI Thanks Heisei Project!
 
@@ -335,7 +362,7 @@
 
 
 DELETE FROM script_texts WHERE entry <= -1665902 AND entry >= -1666080;
-DELETE FROM script_texts WHERE entry <= -1810001 AND entry >= -1810031;
+DELETE FROM script_texts WHERE entry <= -1810001 AND entry >= -1810032;
 
 # 1
 DELETE FROM script_texts WHERE `npc_entry` = 36612;
@@ -610,7 +637,8 @@
 (-1810028, 'Frostmourne feeds on the soul of your fallen ally!',null,null,null,null,null,null,null,null,17368,1,0,0,''),
 (-1810029, 'Val''kyr, your master calls!',null,null,null,null,null,null,null,null,17373,1,0,0,''),
 (-1810030, 'Watch as the world around you collapses!',null,null,null,null,null,null,null,null,17370,1,0,0,''),
-(-1810031, 'You gnats actually hurt me! Perhaps I''ve toyed with you long enough, now taste the vengeance of the grave!',null,null,null,null,null,null,null,null,17359,1,0,0,'');
+(-1810031, 'You gnats actually hurt me! Perhaps I''ve toyed with you long enough, now taste the vengeance of the grave!',null,null,null,null,null,null,null,null,17359,1,0,0,''),
+(-1810032, 'The Lich King begins to cast Defile',null,null,null,null,null,null,null,null,0,3,0,0,'');
 
 # Locale
 
diff --git a/src/server/game/Spells/SpellEffects.cpp b/src/server/game/Spells/SpellEffects.cpp
--- a/src/server/game/Spells/SpellEffects.cpp
+++ b/src/server/game/Spells/SpellEffects.cpp
@@ -4559,36 +4559,7 @@
 
                     }
                     return;
-                }
-                case 72219:
-                case 72551:
-                case 72552:
-                case 72553:
-                {
-                    if(!unitTarget)
-                        return;
-
-                    uint32 spellId = 0;
-                    uint32 auraId = 0;
-
-                    switch (m_spellInfo->Id)
-                    {
-                        case 72219: spellId = 72227; auraId = 72219; break;
-                        case 72551: spellId = 72228; auraId = 72551; break;
-                        case 72552: spellId = 72229; auraId = 72552; break;
-                        case 72553: spellId = 72230; auraId = 72553; break;
-                    }
-
-                    if(Aura* GastricAur = unitTarget->GetAura(auraId))
-                    {
-                        if (GastricAur->GetStackAmount() > 9)
-                        {
-                            unitTarget->RemoveAurasDueToSpell(auraId);
-                            unitTarget->CastSpell(unitTarget, spellId, true);  //cast gastric explosion
-                        }
-                    }
-                    return;
-                }
+                }            
                 case 69200:                                 // Raging Spirit
                 {
                     if (!unitTarget)
diff --git a/src/server/game/Spells/SpellMgr.cpp b/src/server/game/Spells/SpellMgr.cpp
--- a/src/server/game/Spells/SpellMgr.cpp
+++ b/src/server/game/Spells/SpellMgr.cpp
@@ -3726,8 +3726,7 @@
         case 69782: case 69796:                 // Ooze Flood
         case 69798: case 69801:                 // Ooze Flood
         case 69538: case 69553: case 69610:     // Ooze Combine
-	    case 71614:                             // Ice Lock
-
+	  
             mSpellCustomAttr[i] |= SPELL_ATTR_CU_EXCLUDE_SELF;
             count++;
             break;
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_deathbringer_saurfang.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_deathbringer_saurfang.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_deathbringer_saurfang.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_deathbringer_saurfang.cpp
@@ -192,13 +192,8 @@
 
             void JustSummoned(Creature* summon)
             {
-                float x, y, z;
-                if(Unit* pTarget = SelectUnit(SELECT_TARGET_FARTHEST, 0))
-                {
-                    pTarget->GetPosition(x, y, z);
-                    summon->AddThreat(pTarget, 50000.0f);
-                    summon->GetMotionMaster()->MovePoint(0, x, y, z);
-                }
+                if(Unit* pTarget = SelectTarget(SELECT_TARGET_FARTHEST, 1, 100.0f, true))
+                    summon->AI()->AttackStart(pTarget);
             }
 
             void UpdateAI(const uint32 uiDiff)
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_festergut.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_festergut.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_festergut.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_festergut.cpp
@@ -45,7 +45,8 @@
     SPELL_GAS_FLOOD          = 71379,
     SPELL_MORTAL_WOUND       = 71127,
     SPELL_DECIMATE           = 71123,
-    SPELL_PLAGUE_STENCH      = 71805
+    SPELL_PLAGUE_STENCH      = 71805,
+    SPELL_GASTRIC_EXPLOSION  = 72227
 };
 
 static const uint32 gaseousBlight[3]        = {69157, 69162, 69164};
@@ -126,7 +127,7 @@
 
                 if (Creature* professor = Unit::GetCreature(*me, instance->GetData64(DATA_PROFESSOR_PUTRICIDE)))
                     professor->AI()->DoAction(ACTION_FESTERGUT_DEATH);
-                    
+
                 if (Creature* gasDummy = Unit::GetCreature(*me, m_uiGasDummyGUID))
                     gasDummy->RemoveAllAuras();
             }
@@ -303,8 +304,45 @@
         }
 };
 
+class spell_festergut_gastric_bloat : public SpellScriptLoader
+{
+    public:
+        spell_festergut_gastric_bloat() : SpellScriptLoader("spell_festergut_gastric_bloat") { }
+
+
+        class spell_festergut_gastric_bloat_SpellScript : public SpellScript
+        {
+            PrepareSpellScript(spell_festergut_gastric_bloat_SpellScript)
+            void HandleScript(SpellEffIndex /*effIndex*/)
+            {
+                Aura const* aura = GetHitUnit()->GetAura(GetSpellInfo()->Id);
+                if (!(aura && aura->GetStackAmount() == 10))
+                    return;
+
+                SpellEntry const* spellInfo = sSpellStore.LookupEntry(SPELL_GASTRIC_EXPLOSION);
+                if (!spellInfo)
+                    return;
+
+                spellInfo = sSpellMgr.GetSpellForDifficultyFromSpell(spellInfo, GetCaster());
+                GetHitUnit()->RemoveAurasDueToSpell(GetSpellInfo()->Id);
+                GetHitUnit()->CastSpell(GetHitUnit(), spellInfo, true);
+            }
+
+            void Register()
+            {
+                OnEffect += SpellEffectFn(spell_festergut_gastric_bloat_SpellScript::HandleScript, EFFECT_2, SPELL_EFFECT_SCRIPT_EFFECT);
+            }
+        };
+
+        SpellScript* GetSpellScript() const
+        {
+            return new spell_festergut_gastric_bloat_SpellScript();
+        }
+};
+
 void AddSC_boss_festergut()
 {
     new boss_festergut();
     new npc_stinky_icc();
+	new spell_festergut_gastric_bloat();
 }
\ No newline at end of file
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_lady_deathwhisper.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_lady_deathwhisper.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_lady_deathwhisper.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_lady_deathwhisper.cpp
@@ -172,8 +172,9 @@
             {
                 DoCast(pSummon, SPELL_PORT_VISUAL);
 
-                pSummon->AddThreat(me->getVictim(), 1000.0f);
-                pSummon->GetMotionMaster()->MovePoint(1, SpawnLoc[7]);
+                if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                    pSummon->AI()->AttackStart(pTarget);
+
                 summons.Summon(pSummon);
             }
 
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_lord_marrowgar.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_lord_marrowgar.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_lord_marrowgar.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_lord_marrowgar.cpp
@@ -102,7 +102,7 @@
 
                 if (m_uiAchievBonedTimer <= uiDiff)
                 {
-                    pInstance->SetData(DATA_BONED, 1);
+                    pInstance->SetData(DATA_BONED, FAIL);
                     m_uiAchievBonedTimer = 8000;
                 } else m_uiAchievBonedTimer -= uiDiff;
             }
@@ -241,7 +241,10 @@
                 me->SetSpeed(MOVE_RUN, fBaseSpeed, true);
 
                 if (pInstance && me->isAlive())
+                {
+                    pInstance->SetData(DATA_BONED, DONE);
                     pInstance->SetData(DATA_MARROWGAR_EVENT, NOT_STARTED);
+                }
             }
 
             void EnterCombat(Unit* /*pWho*/)
@@ -269,7 +272,7 @@
                 pInstance->SetData(DATA_MARROWGAR_EVENT, DONE);
                 pInstance->DoRemoveAurasDueToSpellOnPlayers(SPELL_SPIKE_IMPALING);
 
-                if(pInstance->GetData(DATA_BONED) == 0)
+                if(pInstance->GetData(DATA_BONED) == DONE)
                     pInstance->DoCompleteAchievement(RAID_MODE(ACHIEV_BONED_10, ACHIEV_BONED_25));
 
                 summons.DespawnAll();
@@ -323,7 +326,7 @@
                 {
                     if (m_uiBoneSpikeGraveyardTimer < uiDiff)
                     {
-                        for (uint8 i = 1; i <= m_uiBoneCount; i++)
+                        for (uint8 i = 1; i <= m_uiBoneCount; ++i)
                         {
                             if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100, true, -SPELL_SPIKE_IMPALING))
                             {
@@ -418,46 +421,46 @@
         }
 };
 
-class spell_lord_marrowgar_bone_storm : public SpellScriptLoader
-{
-    public:
-        spell_lord_marrowgar_bone_storm() : SpellScriptLoader("spell_lord_marrowgar_bone_storm") { }
-
-
-        class spell_lord_marrowgar_bone_storm_SpellScript : public SpellScript
-        {
-            PrepareSpellScript(spell_lord_marrowgar_bone_storm_SpellScript)
-
-            void onEffect(SpellEffIndex /*effIndex*/)
-            {
-                int32 dmg = GetHitDamage();
-                float distance = GetHitUnit()->GetExactDist2d(GetCaster());
-                float distVariant = distance >= 20.0f ? 4 : (10.0f/3.0f);
-                if (distance < 5)
-                    distance = 5; //prevent exploit
-
-                SetHitDamage(int32(dmg * distVariant / distance));
-            }
-
-            void Register()
-            {
-                OnEffect += SpellEffectFn(spell_lord_marrowgar_bone_storm_SpellScript::onEffect, EFFECT_0, SPELL_EFFECT_SCHOOL_DAMAGE);
-            }
-
-            bool Load()
-            {
-                if (GetCaster()->GetEntry() != CREATURE_MARROWGAR)
-                    return false;
-                return true;
-            }
-        };
-
-        SpellScript* GetSpellScript() const
-        {
-            return new spell_lord_marrowgar_bone_storm_SpellScript();
-        }
-};
-
+class spell_lord_marrowgar_bone_storm : public SpellScriptLoader
+{
+    public:
+        spell_lord_marrowgar_bone_storm() : SpellScriptLoader("spell_lord_marrowgar_bone_storm") { }
+
+
+        class spell_lord_marrowgar_bone_storm_SpellScript : public SpellScript
+        {
+            PrepareSpellScript(spell_lord_marrowgar_bone_storm_SpellScript)
+
+            void onEffect(SpellEffIndex /*effIndex*/)
+            {
+                int32 dmg = GetHitDamage();
+                float distance = GetHitUnit()->GetExactDist2d(GetCaster());
+                float distVariant = distance >= 20.0f ? 4 : (10.0f/3.0f);
+                if (distance < 5)
+                    distance = 5; //prevent exploit
+
+                SetHitDamage(int32(dmg * distVariant / distance));
+            }
+
+            void Register()
+            {
+                OnEffect += SpellEffectFn(spell_lord_marrowgar_bone_storm_SpellScript::onEffect, EFFECT_0, SPELL_EFFECT_SCHOOL_DAMAGE);
+            }
+
+            bool Load()
+            {
+                if (GetCaster()->GetEntry() != CREATURE_MARROWGAR)
+                    return false;
+                return true;
+            }
+        };
+
+        SpellScript* GetSpellScript() const
+        {
+            return new spell_lord_marrowgar_bone_storm_SpellScript();
+        }
+};
+
 
 
 void AddSC_boss_lord_marrowgar()
@@ -465,7 +468,7 @@
     new npc_bone_spike();
     new npc_cold_flame();
     new boss_lord_marrowgar();
-	new spell_lord_marrowgar_bone_storm();
+	new spell_lord_marrowgar_bone_storm();
 
 
 	    if (VehicleSeatEntry* vehSeat = const_cast<VehicleSeatEntry*>(sVehicleSeatStore.LookupEntry(6206)))
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_rotface.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_rotface.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_rotface.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_rotface.cpp
@@ -51,7 +51,7 @@
     SPELL_RADIATING_OOZE_1   = 69760,
     SPELL_UNSTABLE_OOZE      = 69558,
     SPELL_EXPLOSION          = 69839,
-    SPELL_EXPLOSION_1        = 69833,
+    SPELL_EXPLOSION_1        = 69832,
     SPELL_MERGE_OOZE         = 69889,
     SPELL_VOLATILE_OOZE      = 70447,
     SPELL_DAZE               = 57416,
@@ -303,8 +303,7 @@
                 DoCast(SPELL_RADIATING_OOZE_1);
                 me->AddUnitMovementFlag(MOVEMENTFLAG_WALKING);
                 me->SetSpeed(MOVE_WALK, 0.5f);
-                me->SetSpeed(MOVE_RUN, 0.5);
-                bExplosion = false;
+                me->SetSpeed(MOVE_RUN, 0.5);               
             }
 
             void EnterCombat(Unit* /*who*/) { }
@@ -336,29 +335,12 @@
                     me->Kill(big);
                 }
 
-                if(!bExplosion)
-                {
-                    if(Aura* UnstableAura = me->GetAura(SPELL_UNSTABLE_OOZE))
-                    {
-                        uint8 stack = UnstableAura->GetStackAmount();
-                        if(stack >= 5)
-                        {
-                            DoCast(me, SPELL_EXPLOSION);
-                            me->RemoveAurasDueToSpell(SPELL_UNSTABLE_OOZE);
-                            DoScriptText(EMOTE_EXPLOSION, me);
-                            DoScriptText(SAY_EXPLOSION, me);
-                            bExplosion = true;
-                        }
-                    }
-                }
-
                 DoMeleeAttackIfReady();
             }
         private:
             InstanceScript* pInstance;
 
             uint32 m_uiStickyOozeTimer;
-            bool bExplosion;
         };
 
         CreatureAI* GetAI(Creature* pCreature) const
@@ -582,46 +564,44 @@
         }
 };
 
-/*class spell_rotface_ooze_flood : public SpellScriptLoader
+class spell_rotface_unstable_explosion : public SpellScriptLoader
 {
     public:
-        spell_rotface_ooze_flood() : SpellScriptLoader("spell_rotface_ooze_flood") { }
+        spell_rotface_unstable_explosion() : SpellScriptLoader("spell_rotface_unstable_explosion") { } //69558
 
 
-        class spell_rotface_ooze_flood_SpellScript : public SpellScript
+        class spell_rotface_unstable_explosion_AuraScript : public AuraScript
         {
-            void HandleApplyAura(SpellEffIndex effIndex)
+            PrepareAuraScript(spell_rotface_unstable_explosion_AuraScript)
+
+            void OnApply(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
             {
-                Creature* puddle = GetCaster()->FindNearestCreature(37824, 200.0f, true);
-                if(puddle)
+                if(Unit* ooze = aurApp->GetBase()->GetCaster())
                 {
-                    puddle->CastSpell(puddle, SPELL_OOZE_FLOOD_1, true);
-                    puddle->CastSpell(puddle, SPELL_OOZE_FLOOD_AURA, true);
+                    if(aurApp->GetBase()->GetStackAmount() >= 5)
+                    {
+                        ooze->RemoveAurasDueToSpell(SPELL_UNSTABLE_OOZE);
+                        ooze->CastSpell(ooze, SPELL_EXPLOSION, true);
+                        DoScriptText(EMOTE_EXPLOSION, ooze);
+                        if (InstanceScript* instance = ooze->GetInstanceScript())
+                            if (Creature* rotface = Unit::GetCreature(*GetCaster(), instance->GetData64(DATA_ROTFACE)))
+                                if (rotface->isAlive())
+                                    DoScriptText(SAY_EXPLOSION, rotface);
+                    }
                 }
             }
 
-
             void Register()
             {
-                OnEffect += SpellEffectFn(spell_rotface_ooze_flood_SpellScript::HandleApplyAura, EFFECT_1, SPELL_EFFECT_APPLY_AURA);
-            }
-
-
-            bool Load()
-            {
-                if (GetCaster()->GetEntry() != CREATURE_PUDDLE_STALKER)
-                    return false;
-                return true;
+                OnEffectApply += AuraEffectApplyFn(spell_rotface_unstable_explosion_AuraScript::OnApply, EFFECT_0, SPELL_AURA_MOD_DAMAGE_PERCENT_DONE, AURA_EFFECT_HANDLE_REAL);
             }
         };
 
-
-        SpellScript* GetSpellScript() const
+        AuraScript* GetAuraScript() const
         {
-            return new spell_rotface_ooze_flood_SpellScript();
+            return new spell_rotface_unstable_explosion_AuraScript();
         }
 };
-*/
 
 void AddSC_boss_rotface()
 {
@@ -632,5 +612,5 @@
     new npc_icc_puddle_stalker();
     new npc_ooze_explode_stalker();
     new npc_precious_icc();
-    //new spell_rotface_ooze_flood();
+    new spell_rotface_unstable_explosion();
 }
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_sindragosa.cpp
@@ -21,7 +21,9 @@
 *Need add  Sindragossa fly in fly phase
 */
 
-#include "ScriptPCH.h"
+#include "ScriptMgr.h"
+#include "SpellScript.h"
+#include "SpellAuraEffects.h"
 #include "icecrown_citadel.h"
 
 enum Yells
@@ -47,10 +49,10 @@
     SPELL_PERMEATING_CHILL    = 70107, //
     SPELL_PERMEATING_AURA     = 70106,
     SPELL_UNCHAINED_MAGIC     = 69762, // нужно узнать механику на офе
-    SPELL_ICY_TRIP_PULL       = 70122,
+    SPELL_ICY_TRIP_PULL       = 70117,
     SPELL_BOMB_VISUAL_1       = 64624,
     SPELL_BOMB_VISUAL_2       = 69016,
-    SPELL_BLISTERING_COLD     = 70123,
+    SPELL_BLISTERING_COLD     = 71047,
     SPELL_FROST_BOMB_TRIGGER  = 69846,
     SPELL_FROST_BEACON        = 70126,
     SPELL_ICE_TOMB            = 70157,
@@ -65,6 +67,11 @@
     SPELL_TAIL_SWEEP          = 71369
 };
 
+enum ePoints
+{
+    POINT_HOME                = 1
+};
+
 const Position SpawnLoc[]=
 {
     {4523.889f, 2486.907f, 280.249f, 3.155f}, //fly pos
@@ -90,13 +97,12 @@
                 m_uiPhase = 1;
 
                 m_uiBreathTimer = 15000;
-                m_uiTailSmashTimer = 11000;
+                m_uiTailSmashTimer = 15000;
                 m_uiBlisteringColdTimer = 30000;
-                m_uiMarkTimer = 20000;
+                m_uiMarkTimer = 25000;
                 m_uiPermatingChilTimer = 12000;
-                m_uiMysticTimer = 6000;
                 m_uiBerserkTimer = 600000;
-                m_uiChangePhaseTimer = 170000;
+                m_uiChangePhaseTimer = 110000;
                 m_uiUnchainedMagicTimer = 12000;
                 m_uiBombTimer = 9000;
                 m_uiCleaveTimer = 5000;
@@ -106,7 +112,8 @@
                 me->SetSpeed(MOVE_RUN, 1.5f, true);
                 me->SetSpeed(MOVE_FLIGHT, 2.5f, true);
 
-                Switch = false;
+                bSwitch = false;
+                bMystic = false;
 
                 if(!pInstance)
                     return;
@@ -125,13 +132,16 @@
 
             void JustDied(Unit* /*pKiller*/)
             {
+                if (!pInstance)
+                    return;
+
                 DoScriptText(SAY_DEATH, me);
 
                 pInstance->DoRemoveAurasDueToSpellOnPlayers(SPELL_PERMEATING_CHILL);
                 pInstance->DoRemoveAurasDueToSpellOnPlayers(SPELL_UNCHAINED_MAGIC);
-
-                if (pInstance)
-                    pInstance->SetData(DATA_SINDRAGOSA_EVENT, DONE);
+                pInstance->SetData(DATA_SINDRAGOSA_EVENT, DONE);
+                if(pInstance->GetData(DATA_ALL_YOU_CAN_EAT) == DONE)
+                    pInstance->DoCompleteAchievement(RAID_MODE(ACHIEV_ALL_YOU_CAN_EAT_10,ACHIEV_ALL_YOU_CAN_EAT_25));
             }
 
             void KilledUnit(Unit* victim)
@@ -148,55 +158,12 @@
 
             void JustReachedHome()
             {
+                if (!pInstance)
+                    return;
+
                 pInstance->DoRemoveAurasDueToSpellOnPlayers(SPELL_PERMEATING_CHILL);
                 pInstance->DoRemoveAurasDueToSpellOnPlayers(SPELL_UNCHAINED_MAGIC);
-
-                if(pInstance)
-                    pInstance->SetData(DATA_SINDRAGOSA_EVENT, FAIL);
-            }
-
-            void BlisteringCold()
-            {
-                Map::PlayerList const &PlList = me->GetMap()->GetPlayers();
-
-                if (PlList.isEmpty())
-                    return;
-
-                for (Map::PlayerList::const_iterator i = PlList.begin(); i != PlList.end(); ++i)
-                {
-                    if (Player* pPlayer = i->getSource())
-                    if (pPlayer && pPlayer->isAlive() && pPlayer->IsWithinDistInMap(me, 25.0f))
-                    {
-                        DoCast(pPlayer, SPELL_ICY_TRIP_PULL);
-                        DoCast(pPlayer, SPELL_BLISTERING_COLD);
-                        DoScriptText(SAY_BLISTERING_COLD, me);
-                    }
-                }
-            }
-
-            void MarkedPlayer()
-            {
-                for (uint8 i = 1; i <= count; i++)
-                {
-                    if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true, -SPELL_FROST_BEACON))
-                        DoCast(pTarget, SPELL_FROST_BEACON);
-                }
-            }
-
-            void Tomb()
-            {
-                for (uint8 i = 1; i <= count; i++)
-                {
-                    if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true, SPELL_FROST_BEACON))
-                    {
-                        DoCast(pTarget, SPELL_ICE_TOMB);
-                        DoCast(pTarget, SPELL_ASPHYXATION);
-                        float x, y, z;
-                        pTarget->GetPosition(x, y, z);
-                        if (Unit* tomb = DoSummon(CREATURE_ICE_TOMB, pTarget))
-                            tomb->AddThreat(pTarget, 500000.0f);
-                     }
-                }
+                pInstance->SetData(DATA_SINDRAGOSA_EVENT, FAIL);
             }
 
             void UpdateAI(const uint32 uiDiff)
@@ -215,11 +182,9 @@
                 {
                     if(m_uiUnchainedMagicTimer <= uiDiff)
                     {
-                        uint32 mcount = urand(1,3);
-                        for (uint8 i = 1; i <= mcount; i++)
+                        for (uint8 i = 1; i <= urand(2, 4); ++i)
                         {
-                            if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM,1))
-                            if(pTarget->getPowerType() == POWER_MANA && !pTarget->HasAura(SPELL_UNCHAINED_MAGIC) && pTarget->GetDistance2d(me->GetPositionX(), me->GetPositionY()) > 5) //hack
+                            if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, -10.0f, true, -SPELL_UNCHAINED_MAGIC))
                             {
                                 DoScriptText(SAY_UNCHAIND_MAGIC, me);
                                 DoCast(pTarget, SPELL_UNCHAINED_MAGIC);
@@ -230,8 +195,7 @@
 
                     if (m_uiPermatingChilTimer <= uiDiff)
                     {
-                        Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM,1);
-                        if(pTarget && !pTarget->HasAura(SPELL_PERMEATING_CHILL) && pTarget->GetDistance2d(me->GetPositionX(), me->GetPositionY()) < 5) //hack
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 10.0f, true, -SPELL_PERMEATING_CHILL))
                         {
                             DoCast(pTarget, SPELL_PERMEATING_CHILL);
                         }
@@ -254,12 +218,14 @@
                     if (m_uiTailSmashTimer <= uiDiff)
                     {
                         DoCast(SPELL_TAIL_SMASH);
-                        m_uiTailSmashTimer = 12000;
+                        m_uiTailSmashTimer = 15000;
                     } else m_uiTailSmashTimer -= uiDiff;
 
                     if (m_uiBlisteringColdTimer <= uiDiff)
                     {
-                        BlisteringCold();
+                        DoCast(SPELL_ICY_TRIP_PULL);
+                        DoCast(SPELL_BLISTERING_COLD);
+                        DoScriptText(SAY_BLISTERING_COLD, me);
                         m_uiBlisteringColdTimer = 30000;
                     } else m_uiBlisteringColdTimer -= uiDiff;
                 }
@@ -268,24 +234,18 @@
                 {
                     if (m_uiMarkTimer < uiDiff)
                     {
-                        MarkedPlayer();
-                        m_uiMarkTimer = 15000;
-                        m_uiIceBoltTriggerTimer = 7000;
+                        for (uint8 i = 1; i <= count; i++)
+                        {
+                            if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true, -SPELL_FROST_BEACON))
+                                DoCast(pTarget, SPELL_FROST_BEACON);
+                        }
+                        m_uiMarkTimer = 25000;
                     } else m_uiMarkTimer -= uiDiff;
 
-                    if (m_uiIceBoltTriggerTimer < uiDiff)
-                    {
-                        Tomb();
-                        m_uiIceBoltTriggerTimer = 31000;
-                    } else m_uiIceBoltTriggerTimer -= uiDiff;
-
                     if (m_uiBombTimer <= uiDiff)
                     {
                         if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                        {
                             DoCast(pTarget, SPELL_FROST_BOMB);
-                            DoCast(pTarget, SPELL_FROST_BOMB_TRIGGER);
-                        }
                         m_uiBombTimer = 10000;
                     } else m_uiBombTimer -= uiDiff;
                 }
@@ -294,9 +254,12 @@
                 {
                     if (m_uiMarkTimer < uiDiff)
                     {
-                        MarkedPlayer();
-                        m_uiMarkTimer = 15000;
-                        m_uiIceBoltTriggerTimer = 7000;
+                        for (uint8 i = 1; i <= count; ++i)
+                        {
+                            if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true, -SPELL_FROST_BEACON))
+                                DoCast(pTarget, SPELL_FROST_BEACON);
+                        }
+                        m_uiMarkTimer = 25000;
                     } else m_uiMarkTimer -= uiDiff;
 
                     if (m_uiBreathTimer <= uiDiff)
@@ -306,40 +269,23 @@
                         m_uiBreathTimer = 15000;
                     } else m_uiBreathTimer -= uiDiff;
 
-                    if (m_uiMysticTimer <= uiDiff)
+                    if(!bMystic)
                     {
-                        Map::PlayerList const &PlList = me->GetMap()->GetPlayers();
-
-                        for (Map::PlayerList::const_iterator i = PlList.begin(); i != PlList.end(); ++i)
-                        {
-                            if (Player* pPlayer = i->getSource())
-                            {
-                                if (pPlayer && pPlayer->GetDistance2d(me->GetPositionX(), me->GetPositionY()) <= 10)
-                                {
-                                    DoCast(pPlayer, SPELL_MYSTIC_BUFFED);
-                                }
-                            }
-                        }
-                       m_uiMysticTimer = 6000;
-                    } else m_uiMysticTimer -= uiDiff;
-
-                    if (m_uiIceBoltTriggerTimer < uiDiff)
-                    {
-                        Tomb();
-                        m_uiIceBoltTriggerTimer = 31000;
-                    } else m_uiIceBoltTriggerTimer -= uiDiff;
+                       DoCast(me, SPELL_MYSTIC_BUFFED);
+                       bMystic = true;
+                    }
                 }
 
-                if((HealthBelowPct(36)) && !Switch)
+                if((HealthBelowPct(36)) && !bSwitch)
                 {
                     DoScriptText(SAY_PHASE_3, me);
                     m_uiPhase = 3;
-                    Switch = true;
+                    bSwitch = true;
                 }
 
                 if (m_uiChangePhaseTimer < uiDiff)
                 {
-                    if(!Switch)
+                    if(!bSwitch)
                     {
                         if(m_uiPhase == 1)
                         {
@@ -351,7 +297,7 @@
                             m_uiPhase = 1;
                         }
                     }
-                    m_uiChangePhaseTimer = 170000;
+                    m_uiChangePhaseTimer = 110000;
                 } else m_uiChangePhaseTimer -= uiDiff;
 
                 DoMeleeAttackIfReady();
@@ -367,17 +313,15 @@
             uint32 m_uiBlisteringColdTimer;
             uint32 m_uiBerserkTimer;
             uint32 m_uiMarkTimer;
-            uint32 m_uiIceBoltTriggerTimer;
             uint32 m_uiFlyTimer;
-            uint32 m_uiMysticTimer;
-            uint32 m_uiResetTimer;
             uint32 m_uiPermatingChilTimer;
             uint32 m_uiChangePhaseTimer;
             uint32 m_uiUnchainedMagicTimer;
             uint32 m_uiBombTimer;
             uint8 count;
 
-            bool Switch;
+            bool bSwitch;
+            bool bMystic;
         };
 
         CreatureAI* GetAI(Creature* pCreature) const
@@ -391,49 +335,46 @@
     public:
         npc_ice_tomb() : CreatureScript("npc_ice_tomb") { }
 
-        struct npc_ice_tombAI: public ScriptedAI
+        struct npc_ice_tombAI: public Scripted_NoMovementAI
         {
-            npc_ice_tombAI(Creature* pCreature) : ScriptedAI(pCreature)
+            npc_ice_tombAI(Creature* pCreature) : Scripted_NoMovementAI(pCreature)
             {
                 IceTombGUID = 0;
             }
 
-            void SetPrisoner(Unit* uPrisoner)
+            void SetGUID(const uint64& guid)
             {
-                IceTombGUID = uPrisoner->GetGUID();
+                IceTombGUID = guid;
             }
 
             void Reset()
             {
-                SetCombatMovement(false);
                 IceTombGUID = 0;
             }
 
-            void JustDied(Unit *killer)
+            void JustDied(Unit* pKiller)
             {
-                if (killer->GetGUID() != me->GetGUID())
-
-                    if (IceTombGUID)
-                    {
-                        Unit* IceTomb = Unit::GetUnit((*me), IceTombGUID);
-                        if (IceTomb)
-                            IceTomb->RemoveAurasDueToSpell(SPELL_ICE_TOMB);
-                    }
+                if (Player* IceTomb = ObjectAccessor::GetPlayer(*me, IceTombGUID))
+                {
+                    IceTomb->RemoveAurasDueToSpell(SPELL_ICE_TOMB);
+                    IceTomb->RemoveAurasDueToSpell(SPELL_ASPHYXATION);
+                }
             }
 
             void KilledUnit(Unit *pVictim)
             {
-                if (pVictim->GetGUID() != me->GetGUID())
-
-                    if (IceTombGUID)
-                    {
-                        Unit* IceTomb = Unit::GetUnit((*me), IceTombGUID);
-                        if (IceTomb)
-                            IceTomb->RemoveAurasDueToSpell(SPELL_ICE_TOMB);
-                    }
+                me->Kill(me);
             }
 
-            void UpdateAI(const uint32 uiDiff) { }
+            void UpdateAI(const uint32 /*uiDiff*/)
+            {
+                if(!IceTombGUID)
+                    return;
+
+                if (Player* IceTomb = ObjectAccessor::GetPlayer(*me, IceTombGUID))
+                    if (!IceTomb->HasAura(SPELL_ICE_TOMB))
+                        me->Kill(me);
+            }
 
         private:
             uint64 IceTombGUID;
@@ -645,6 +586,109 @@
         }
 };
 
+class spell_sindragosa_ice_tomb : public SpellScriptLoader
+{
+    public:
+        spell_sindragosa_ice_tomb() : SpellScriptLoader("spell_sindragosa_ice_tomb") { } //70157
+
+
+        class spell_sindragosa_ice_tomb_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_sindragosa_ice_tomb_AuraScript)
+
+            void OnRemove(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if(Unit* beacon = aurApp->GetBase()->GetCaster())
+                {
+                    if (InstanceScript* instance = aurApp->GetBase()->GetOwner()->GetInstanceScript())
+                        if (Creature* sindragosa = Unit::GetCreature(*aurApp->GetBase()->GetOwner(), instance->GetData64(DATA_SINDRAGOSA)))
+                            if(sindragosa->isAlive())
+                                sindragosa->CastSpell(beacon, SPELL_ICE_TOMB, true);
+
+                    beacon->CastSpell(beacon, SPELL_ASPHYXATION, true);
+                    Creature* tomb = beacon->SummonCreature(CREATURE_ICE_TOMB, beacon->GetPositionX(), beacon->GetPositionY(), beacon->GetPositionZ(), 0, TEMPSUMMON_CORPSE_DESPAWN);
+                    if(tomb)
+                        tomb->AI()->SetGUID(beacon->GetGUID());
+                }
+            }
+
+            void Register()
+            {
+                OnEffectRemove += AuraEffectRemoveFn(spell_sindragosa_ice_tomb_AuraScript::OnRemove, EFFECT_2, SPELL_AURA_PERIODIC_TRIGGER_SPELL, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_sindragosa_ice_tomb_AuraScript();
+        }
+};
+
+class spell_sindragosa_mystic_buffet : public SpellScriptLoader
+{
+    public:
+        spell_sindragosa_mystic_buffet() : SpellScriptLoader("spell_sindragosa_mystic_buffet") { } //70127
+
+
+        class spell_sindragosa_mystic_buffet_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_sindragosa_mystic_buffet_AuraScript)
+
+            void OnApply(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if (InstanceScript* instance = aurApp->GetBase()->GetOwner()->GetInstanceScript())
+                    if(aurApp->GetBase()->GetStackAmount() >= 5)
+                        instance->SetData(DATA_ALL_YOU_CAN_EAT, FAIL);
+                    else
+                        instance->SetData(DATA_ALL_YOU_CAN_EAT, DONE);
+            }
+
+            void Register()
+            {
+                OnEffectApply += AuraEffectApplyFn(spell_sindragosa_mystic_buffet_AuraScript::OnApply, EFFECT_0, SPELL_AURA_MOD_DAMAGE_PERCENT_TAKEN, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_sindragosa_mystic_buffet_AuraScript();
+        }
+};
+
+class spell_sindragosa_unchained_magic : public SpellScriptLoader
+{
+    public:
+        spell_sindragosa_unchained_magic() : SpellScriptLoader("spell_sindragosa_unchained_magic") { } //69766
+
+
+        class spell_sindragosa_unchained_magic_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_sindragosa_unchained_magic_AuraScript)
+
+            void OnRemove(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                Unit* caster = GetCaster();
+                if (!caster)
+                    return;
+
+                SpellEntry const* spell = sSpellStore.LookupEntry(71044);
+                spell = sSpellMgr.GetSpellForDifficultyFromSpell(spell, caster);
+                int32 damage = (aurApp->GetBase()->GetStackAmount() * 2000);
+                aurApp->GetTarget()->CastCustomSpell(71044, SPELLVALUE_BASE_POINT0, damage, aurApp->GetTarget(), true, NULL, aurEff, GetCasterGUID());
+            }
+
+            void Register()
+            {
+                OnEffectRemove += AuraEffectRemoveFn(spell_sindragosa_unchained_magic_AuraScript::OnRemove, EFFECT_0, SPELL_AURA_DUMMY, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_sindragosa_unchained_magic_AuraScript();
+        }
+};
+
 void AddSC_boss_sindragosa()
 {
     new boss_sindragosa();
@@ -652,4 +696,7 @@
     new npc_rimefang();
     new npc_ice_tomb();
     new npc_frost_bomb();
+	new spell_sindragosa_ice_tomb();
+	new spell_sindragosa_mystic_buffet(); //for achievement
+	new spell_sindragosa_unchained_magic();
 }
\ No newline at end of file
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/boss_the_lich_king.cpp b/src/server/scripts/Northrend/IcecrownCitadel/boss_the_lich_king.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/boss_the_lich_king.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/boss_the_lich_king.cpp
@@ -1,1294 +1,1260 @@
-/*
-* Copyright (C) 2009 - 2010 TrinityCore <http://www.trinitycore.org/>
-*
-* This program is free software; you can redistribute it and/or modify
-* it under the terms of the GNU General Public License as published by
-* the Free Software Foundation; either version 2 of the License, or
-* (at your option) any later version.
-*
-* This program is distributed in the hope that it will be useful,
-* but WITHOUT ANY WARRANTY; without even the implied warranty of
-* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
-* GNU General Public License for more details.
-*
-* You should have received a copy of the GNU General Public License
-* along with this program; if not, write to the Free Software
-* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
-*/
-
-#include "ObjectMgr.h"
-#include "ScriptMgr.h"
-#include "ScriptedCreature.h"
-#include "SpellScript.h"
-#include "SpellAuraEffects.h"
-#include "icecrown_citadel.h"
-
-/*
-//Speaking to Tirion Fordring to begin the fight
-Long have I waited for this day, hero. Are you and your allies prepared to bring the Lich King to justice? We charge on your command!
- We are prepared, Highlord. Let us battle for the fate of Azeroth! For the light of dawn!
-*/
-#define GOSSIP_START_EVENT "We are prepared, Highlord. Let us battle for the fate of Azeroth! For the light of dawn!"
-
-enum Yells
-{
-    SAY_INTRO_1_KING         = -1810001,
-    SAY_INTRO_2_TIRION       = -1810002,
-    SAY_INTRO_3_KING         = -1810003,
-    SAY_INTRO_4_TIRION       = -1810004,
-    SAY_INTRO_5_KING         = -1810005,
-    SAY_AGGRO_KING           = -1810006,
-    SAY_REMORSELESS_WINTER   = -1810007,
-    SAY_RANDOM_1             = -1810008,
-    SAY_RANDOM_2             = -1810009,
-    SAY_KILL_1               = -1810010,
-    SAY_KILL_2               = -1810011,
-    SAY_BERSERK              = -1810012,
-    SAY_ENDING_1_KING        = -1810013,
-    SAY_ENDING_2_KING        = -1810014,
-    SAY_ENDING_3_KING        = -1810015,
-    SAY_ENDING_4_KING        = -1810016,
-    SAY_ENDING_5_TIRION      = -1810017,
-    SAY_ENDING_6_KING        = -1810018,
-    SAY_ENDING_8_TIRION      = -1810020,
-    SAY_ENDING_9_FATHER      = -1810021,
-    SAY_ENDING_10_TIRION     = -1810022,
-    SAY_ENDING_11_FATHER     = -1810023,
-    SAY_ENDING_12_KING       = -1810024,
-    SAY_DEATH_KING           = -1810025,
-    SAY_ESCAPE_FROSTMOURNE   = -1810026,
-    SAY_HARVEST_SOUL         = -1810027,
-    SAY_DEVOURED_FROSTMOURNE = -1810028,
-    SAY_SUMMON_VALKYR        = -1810029,
-    SAY_BROKEN_ARENA         = -1810030,
-    SAY_10_PROZENT           = -1810031
-};
-
-enum Spells
-{
-    SPELL_SUMMON_SHAMBLING_HORROR    = 70372,
-    SPELL_SUMMON_DRUDGE_GHOULS       = 70359,
-    SPELL_SUMMON_ICE_SPEHERE         = 69103,
-    SPELL_SUMMON_RAGING_SPIRIT       = 69200,
-    SPELL_SUMMON_VALKYR              = 74361,
-    SPELL_SUMMON_DEFILE              = 72762,
-    SPELL_SUMMON_VILE_SPIRIT         = 70498,
-    SPELL_SUMMON_BROKEN_FROSTMOURNE  = 72406,
-    SPELL_SUMMON_SHADOW_TRAP         = 73539,
-    SPELL_INFEST                     = 70541,
-    SPELL_NECROTIC_PLAGUE            = 70338,
-    SPELL_NECROTIC_PLAGUE_IMMUNITY   = 72846,
-    SPELL_PLAGUE_SIPHON              = 74074,
-    SPELL_REMORSELES_WINTER          = 68981,
-    SPELL_PAIN_AND_SUFFERING         = 72133,
-    SPELL_WINGS_OF_THE_DAMNED        = 74352,
-    SPELL_SOUL_REAPER                = 69409,
-    SPELL_HARVEST_SOUL_TELEPORT      = 71372,
-    SPELL_HARVEST_SOULS              = 74325,
-    SPELL_QUAKE                      = 72262,
-    SPELL_CHANNEL_KING               = 71769,
-    SPELL_BROKEN_FROSTMOURNE         = 72398,
-    SPELL_BOOM_VISUAL                = 72726,
-    SPELL_ICEBLOCK_TRIGGER           = 71614,
-    SPELL_TIRION_LIGHT               = 71797,
-    SPELL_FROSTMOURNE_TRIGGER        = 72405,
-    SPELL_DISENGAGE                  = 61508,
-    SPELL_FURY_OF_FROSTMOURNE        = 72350,
-    SPELL_REVIVE_VISUAL              = 37755,
-    SPELL_REVIVE                     = 72423,
-    SPELL_CLONE_PLAYER               = 57507,
-    SPELL_RAGING_SPIRIT_VISUAL       = 69198,
-    SPELL_DEFILE                     = 72743,
-    SPELL_ICE_SPHERE_VISUAL          = 69090,
-    SPELL_ICE_PULSE                  = 69099,
-    SPELL_ICE_BURST                  = 69108,
-    SPELL_LIFE_SIPHON                = 73783,
-    SPELL_SOUL_SHRIEK                = 69242,
-    SPELL_WHOCKVAWE                  = 72149,
-    SPELL_ENRAGE                     = 72143,
-    SPELL_BURST                      = 70503
-};
-
-enum ePoints
-{
-    POINT_PLATFORM_CENTRE            = 1
-};
-
-struct Position MovePos[]=
-{
-    {461.792633f, -2125.855957f, 1040.860107f, 0.0f}, // move
-    {503.156525f, -2124.516602f, 1040.860107f, 0.0f}, // move ending
-    {490.110779f, -2124.989014f, 1040.860352f, 0.0f}, // move tirion frostmourne
-    {478.333466f, -2124.618652f, 1040.859863f, 0.0f}, // move tirion attack
-    {498.004486f, 2201.573486f, 1046.093872f, 0.0f}  // move valkyr
-};
-
-struct Locations
-{
-    float x,y,z;
-};
-
-static Locations TeleportPoint[]=
-{
-    {959.996f, 212.576f, 193.843f},
-    {932.537f, 231.813f, 193.838f},
-    {958.675f, 254.767f, 193.822f},
-    {946.955f, 201.316f, 192.535f},
-    {944.294f, 149.676f, 197.551f},
-    {930.548f, 284.888f, 193.367f},
-    {965.997f, 278.398f, 195.777f},
-};
-
-Creature* pLichKing;
-Creature* pTirion;
-Creature* pFather;
-Creature* pFrostmourne;
-Creature* pSafeZone;
-
-class boss_the_lich_king : public CreatureScript
-{
-    public:
-        boss_the_lich_king() : CreatureScript("boss_the_lich_king") { }
-
-        struct boss_the_lich_kingAI : public BossAI
-        {
-            boss_the_lich_kingAI(Creature* pCreature) : BossAI(pCreature, DATA_LICH_KING_EVENT), summons(me)
-            {
-                pInstance = me->GetInstanceScript();
-                pLichKing = me;
-            }
-
-            void Reset()
-            {
-                me->SetReactState(REACT_PASSIVE);
-
-                m_uiPhase = 1;
-                m_uiRandomSpeechTimer = 33000;
-                m_uiBerserkTimer = 900000;
-                m_uiSummonShamblingHorrorTimer = 20000;
-                m_uiSummonDrudgeGhoulsTimer = 30000;
-                m_uiInfestTimer = 30000;
-                m_uiNecroticPlagueTimer = !bCast ? 30000 : 30000000;
-                m_uiPlagueSiphonTimer = 5000;
-                m_uiTirionSpawnTimer = 5000;
-                m_uiIcePulsSummonTimer = 10000;
-                m_uiPainandSufferingTimer = 10000;
-                m_uiSummonSpiritTimer = 18000;
-                m_uiSummonValkyrTimer = 35000;
-                m_uiSoulReaperTimer = 25000;
-                m_uiDefileTimer = 25000;
-                m_uiInfestTimer = 40000;
-                m_uiSummonVileSpiritTimer = 30000;
-                m_uiHarvestSoulTimer = 70000;
-                m_uiSummonShadowTrap = 20000;
-                m_uiEndingTimer = 1000;
-                m_uiEndingPhase = 1;
-
-                TriggerSpawned = false;
-                TransitionPhase1 = false;
-                TransitionPhase2 = false;
-                TransitionPhase3 = false;
-                bEnding = false;
-                bQuake = false;
-				bCast = false;
-
-                if(pInstance)
-                    if(me->isAlive())
-                        pInstance->SetData(DATA_LICH_KING_EVENT, NOT_STARTED);
-
-                summons.DespawnAll();
-
-                me->SetSpeed(MOVE_RUN, 1.8f);
-                me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_DISARMED);
-
-                if (me->GetMotionMaster()->GetCurrentMovementGeneratorType() == POINT_MOTION_TYPE)
-                    me->GetMotionMaster()->MovementExpired();
-            }
-
-            void EnterCombat(Unit* /*pWho*/)
-            {
-                DoScriptText(SAY_AGGRO_KING, me);
-            }
-
-            void JustDied(Unit* /*pKiller*/)
-            {
-                DoScriptText(SAY_DEATH_KING, me);
-
-                if(pInstance)
-                    pInstance->SetData(DATA_LICH_KING_EVENT, DONE);
-
-                summons.DespawnAll();
-                
-                PlayerCinematic();
-            }
-            
-      void MovementInform(uint32 type, uint32 id)
-{
-	if(type != POINT_MOTION_TYPE)
-		return;
-
-	if(id == POINT_PLATFORM_CENTRE)
-	{
-		DoScriptText(SAY_REMORSELESS_WINTER, me);
-		DoCast(me, SPELL_REMORSELES_WINTER);
-		bQuake = true;
-	}
-	  }
-
-            void PlayerCinematic()
-            {
-                Map::PlayerList const &PlList = me->GetMap()->GetPlayers();
-
-                if (PlList.isEmpty())
-                    return;
-
-                for (Map::PlayerList::const_iterator i = PlList.begin(); i != PlList.end(); ++i)
-                {
-                    if (Player* pPlayer = i->getSource())
-                    {
-                        if(pPlayer)
-                        {
-                            pPlayer->SendMovieStart(16);
-                        }
-                    }
-                }
-            }
-
-            void JustReachedHome()
-            {
-                if(pInstance)
-                    pInstance->SetData(DATA_LICH_KING_EVENT, FAIL);
-
-                summons.DespawnAll();
-            }
-
-            void KilledUnit(Unit* victim)
-            {
-                if(!TransitionPhase3)
-                {
-                    if (victim->GetTypeId() == TYPEID_PLAYER)
-                    {
-                        switch(rand()%1)
-                        {
-                            case 0: DoScriptText(SAY_KILL_1, me); break;
-                            case 1: DoScriptText(SAY_KILL_2, me); break;
-                        }
-                    }
-                }
-            }
-
-            void JustSummoned(Creature* summoned)
-            {
-                float x,y,z;
-                if(Unit* target = SelectUnit(SELECT_TARGET_RANDOM,1))
-                {
-                    target->GetPosition(x,y,z);
-                    summoned->AddThreat(target, 1000.0f);
-                    summoned->GetMotionMaster()->MovePoint(0,x,y,z);
-                }
-                summons.Summon(summoned);
-            }
-
-            void Phasenswitch()
-            {
-                me->SetReactState(REACT_PASSIVE);
-                me->AttackStop();
-                me->GetMotionMaster()->MovePoint(POINT_PLATFORM_CENTRE, MovePos[1]);
-            }
-
-            void PlayerRevive()
-            {
-                Map::PlayerList const &PlList = pFather->GetMap()->GetPlayers();
-
-                if (PlList.isEmpty())
-                    return;
-
-                for (Map::PlayerList::const_iterator i = PlList.begin(); i != PlList.end(); ++i)
-                {
-                    if (Player* pPlayer = i->getSource())
-                    {
-                        if (pPlayer && pPlayer->isDead())
-                        {
-                            pFather->CastSpell(pPlayer, SPELL_REVIVE, true);
-                        }
-                    }
-                }
-            }
-
-            void UpdateAI(const uint32 uiDiff)
-            {
-                if (!UpdateVictim())
-                    return;
-
-                if(!TransitionPhase3)
-                {
-                    if (m_uiRandomSpeechTimer < uiDiff)
-                    {
-                        DoScriptText(RAND(SAY_RANDOM_1,SAY_RANDOM_2), me);
-                        m_uiRandomSpeechTimer = 33000;
-                    } else m_uiRandomSpeechTimer -= uiDiff;
-                }
-
-                if (m_uiBerserkTimer < uiDiff)
-                {
-                    DoScriptText(SAY_BERSERK, me);
-                    DoCast(me, SPELL_BERSERK);
-                    m_uiBerserkTimer = 900000;
-                } else m_uiBerserkTimer -= uiDiff;
-
-                if(m_uiPhase == 1)
-                {
-                    if (IsHeroic())
-                    {
-                        if (m_uiSummonShadowTrap < uiDiff)
-                        {
-                            if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
-                                DoCast(pTarget, SPELL_SUMMON_SHADOW_TRAP, true);
-                            m_uiSummonShadowTrap = 30000;
-                        } else m_uiSummonShadowTrap -= uiDiff;
-                    }
-
-                    if (m_uiInfestTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_INFEST);
-                        m_uiInfestTimer = 30000;
-                    } else m_uiInfestTimer -= uiDiff;
-
-                    if (m_uiSummonDrudgeGhoulsTimer < uiDiff)
-                    {
-                        DoCast(me, SPELL_SUMMON_DRUDGE_GHOULS);
-                        m_uiSummonDrudgeGhoulsTimer = 20000;
-                    } else m_uiSummonDrudgeGhoulsTimer -= uiDiff;
-
-                    if (m_uiSummonShamblingHorrorTimer < uiDiff)
-                    {
-                        DoCast(me, SPELL_SUMMON_SHAMBLING_HORROR);
-                        m_uiSummonShamblingHorrorTimer = 30000;
-                    } else m_uiSummonShamblingHorrorTimer -= uiDiff;
-
-                    if (m_uiNecroticPlagueTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_NECROTIC_PLAGUE);
-                        m_uiNecroticPlagueTimer = !bCast ? 30000 : 30000000;
-                    } else m_uiNecroticPlagueTimer -= uiDiff;
-                }
-
-                if(m_uiPhase == 2) //transition phase 1
-                {
-                    if(bQuake && !me->HasAura(SPELL_REMORSELES_WINTER))
-                    {
-                        DoScriptText(SAY_BROKEN_ARENA, me);
-                        DoCast(SPELL_QUAKE);
-                        m_uiPhase = 3;
-                        bQuake = false;
-                    }
-
-                    if (m_uiSummonSpiritTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_SUMMON_RAGING_SPIRIT);
-                        m_uiSummonSpiritTimer = 16000;
-                    } else m_uiSummonSpiritTimer -= uiDiff;
-
-                    if (m_uiIcePulsSummonTimer < uiDiff)
-                    {
-                        DoCast(SPELL_SUMMON_ICE_SPEHERE);
-                        m_uiIcePulsSummonTimer = 15000;
-                    } else m_uiIcePulsSummonTimer -= uiDiff;
-
-                    if (m_uiPainandSufferingTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_PAIN_AND_SUFFERING);
-                        m_uiPainandSufferingTimer = 2000;
-                    } else m_uiPainandSufferingTimer -= uiDiff;
-                }
-
-                if(m_uiPhase == 3)
-                {
-                    if (m_uiDefileTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_SUMMON_DEFILE);
-                        m_uiDefileTimer = 20000;
-                    } else m_uiDefileTimer -= uiDiff;
-
-                    if (m_uiSummonValkyrTimer < uiDiff)
-                    {
-                        DoScriptText(SAY_SUMMON_VALKYR, me);
-                        DoCast(me, SPELL_SUMMON_VALKYR);
-                        m_uiSummonValkyrTimer = 35000;
-                    } else m_uiSummonValkyrTimer -= uiDiff;
-
-                    if (m_uiSoulReaperTimer < uiDiff)
-                    {
-                        DoCast(me->getVictim(), SPELL_SOUL_REAPER);
-                        m_uiSoulReaperTimer = 25000;
-                    } else m_uiSoulReaperTimer -= uiDiff;
-
-                    if (m_uiInfestTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_INFEST);
-                        m_uiInfestTimer = 30000;
-                    } else m_uiInfestTimer -= uiDiff;
-                }
-
-                if(m_uiPhase == 4) //transition phase 1
-                {
-                    if(bQuake && !me->HasAura(SPELL_REMORSELES_WINTER))
-                    {
-                        DoScriptText(SAY_BROKEN_ARENA, me);
-                        DoCast(SPELL_QUAKE);
-                        m_uiPhase = 5;
-                        bQuake = false;
-                    }
-
-                    if (m_uiSummonSpiritTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_SUMMON_RAGING_SPIRIT);
-                        m_uiSummonSpiritTimer = 16000;
-                    } else m_uiSummonSpiritTimer -= uiDiff;
-
-                    if (m_uiIcePulsSummonTimer < uiDiff)
-                    {
-                        DoCast(me, SPELL_SUMMON_ICE_SPEHERE);
-                        m_uiIcePulsSummonTimer = 15000;
-                    } else m_uiIcePulsSummonTimer -= uiDiff;
-
-                    if (m_uiPainandSufferingTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_PAIN_AND_SUFFERING);
-                        m_uiPainandSufferingTimer = 3000;
-                    } else m_uiPainandSufferingTimer -= uiDiff;
-                }
-
-                if(m_uiPhase == 5)
-                {
-                    if (m_uiSummonVileSpiritTimer < uiDiff)
-                    {
-                        DoCast(me, SPELL_SUMMON_VILE_SPIRIT);
-                        m_uiSummonVileSpiritTimer = 30000;
-                    } else m_uiSummonVileSpiritTimer -= uiDiff;
-
-                    if (m_uiHarvestSoulTimer < uiDiff)
-                    {
-                        DoScriptText(SAY_HARVEST_SOUL, me);
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_HARVEST_SOULS);
-                        m_uiHarvestSoulTimer = 70000;
-                    } else m_uiHarvestSoulTimer -= uiDiff;
-
-                    if (m_uiSoulReaperTimer < uiDiff)
-                    {
-                        DoCast(me->getVictim(), SPELL_SOUL_REAPER);
-                        m_uiSoulReaperTimer = 25000;
-                    } else m_uiSoulReaperTimer -= uiDiff;
-
-                    if (m_uiDefileTimer < uiDiff)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                            DoCast(pTarget, SPELL_SUMMON_DEFILE);
-                        m_uiDefileTimer = 20000;
-                    } else m_uiDefileTimer -= uiDiff;
-                }
-
-                if(HealthBelowPct(71))
-                {
-                    if(!TransitionPhase1)
-                    {
-                        TransitionPhase1 = true;
-                        m_uiPhase = 2; // переходная первая фаза
-                        Phasenswitch();
-                    }
-                }
-
-                if(HealthBelowPct(41))
-                {
-                    if(!TransitionPhase2)
-                    {
-                        TransitionPhase2 = true;
-                        m_uiPhase = 4;
-                        Phasenswitch();
-                    }
-                }
-
-                if(HealthBelowPct(12))
-                {
-                    if(!TriggerSpawned)
-                    {
-                        pSafeZone = me->SummonCreature(CREATURE_TRIGGER, me->GetPositionX(), me->GetPositionY(), me->GetPositionZ(), 0, TEMPSUMMON_CORPSE_DESPAWN, 360000);
-                        pSafeZone->AI()->AttackStart(me);
-                        pSafeZone->SetDisplayId(MODEL_INVISIBLE);
-                        TriggerSpawned = true;
-                }   }
-
-                if(HealthBelowPct(11))
-                {
-                    if(!TransitionPhase3)
-                    {
-                        TransitionPhase3 = true;
-                        bEnding = true;
-                    }
-                }
-
-                if(bEnding)
-                {
-                    if (m_uiEndingTimer <= uiDiff)
-                    {
-                        switch(m_uiEndingPhase)
-                        {
-                        case 1:
-                            me->GetMotionMaster()->MoveIdle();
-                            me->SetReactState(REACT_PASSIVE);
-                            me->AttackStop();
-                            me->CastStop();
-                            DoResetThreat();
-                            DoScriptText(SAY_10_PROZENT, me);
-                            DoCastAOE(SPELL_FURY_OF_FROSTMOURNE);
-                            m_uiEndingTimer = 15000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 2:
-                            DoScriptText(SAY_ENDING_1_KING, me);
-                            m_uiEndingTimer = 24000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 3:
-                            DoScriptText(SAY_ENDING_2_KING, me);
-                            m_uiEndingTimer = 25000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 4:
-                            me->GetMotionMaster()->MovePoint(POINT_PLATFORM_CENTRE, MovePos[1]);
-                            m_uiEndingTimer = 4000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 5:
-                            DoCastAOE(SPELL_CHANNEL_KING);
-                            DoScriptText(SAY_ENDING_3_KING, me);
-                            m_uiEndingTimer = 26000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 6:
-                            DoScriptText(SAY_ENDING_4_KING, me);
-                            m_uiEndingTimer = 9000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 7:
-                            DoScriptText(SAY_ENDING_5_TIRION, pTirion);
-                            m_uiEndingTimer = 9000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 8:
-                            DoCast(pTirion, SPELL_TIRION_LIGHT);
-                            m_uiEndingTimer = 5000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 9:
-                            pTirion->RemoveAurasDueToSpell(SPELL_ICEBLOCK_TRIGGER);
-                            m_uiEndingTimer = 2000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 10:
-                            pTirion->GetMotionMaster()->MovePoint(0, MovePos[2]);
-                            m_uiEndingTimer = 1000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 11:
-                            pTirion->GetMotionMaster()->MoveJump(517.482910f, -2124.905762f, 1040.861328f, 10.0f, 15.0f); //pTirion->JumpTo(pFrostmourne, 15.0f);
-                            pTirion->SetUInt32Value(UNIT_NPC_EMOTESTATE, 375);
-                            m_uiEndingTimer = 1000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 12:
-                            me->RemoveAura(SPELL_CHANNEL_KING);
-                            me->CastSpell(me, SPELL_BOOM_VISUAL, false);
-                            m_uiEndingTimer = 300;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 13:
-                            me->CastSpell(me, SPELL_SUMMON_BROKEN_FROSTMOURNE, false);
-                            m_uiEndingTimer = 3000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 14:
-                            me->CastSpell(me, 73017, false);
-                            m_uiEndingTimer = 1000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 15:
-                            DoScriptText(SAY_ENDING_6_KING, me);
-                            m_uiEndingTimer = 3000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 16:
-                            pFrostmourne = me->SummonCreature(27880, me->GetPositionX()+2, me->GetPositionY()+2, me->GetPositionZ(), 0, TEMPSUMMON_TIMED_OR_CORPSE_DESPAWN, 99999999);
-                            pFrostmourne->CastSpell(pFrostmourne, SPELL_BROKEN_FROSTMOURNE, false);
-                            pFrostmourne->CastSpell(pFrostmourne, SPELL_FROSTMOURNE_TRIGGER, false);
-                            pFrostmourne->GetMotionMaster()->MoveChase(me);
-                            me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_DISARMED);
-                            //pTirion->CastSpell(pTirion, SPELL_DISENGAGE, false);
-                            m_uiEndingTimer = 2000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 17:
-                            me->RemoveAllAuras();
-                            me->RemoveAura(SPELL_SUMMON_BROKEN_FROSTMOURNE);
-                            DoPlaySoundToSet(me, SOUND_ENDING_7_KING);
-                            me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 473);
-                            m_uiEndingTimer = 5000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 18:
-                            DoScriptText(SAY_ENDING_8_TIRION, pTirion);
-                            m_uiEndingTimer = 6000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 19:
-                            pFather = me->SummonCreature(CREAUTRE_MENETHIL, me->GetPositionX()+5, me->GetPositionY()+5, me->GetPositionZ(), 0, TEMPSUMMON_TIMED_OR_CORPSE_DESPAWN, 9999999);
-                            DoScriptText(SAY_ENDING_9_FATHER, pFather);
-                            PlayerRevive();
-                            m_uiEndingTimer = 6000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 20:
-                            DoScriptText(SAY_ENDING_11_FATHER, pFather);
-                            pFather->CastSpell(pFather, SPELL_REVIVE_VISUAL, false);
-                            m_uiEndingTimer = 6000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 21:
-                            DoScriptText(SAY_ENDING_10_TIRION, pTirion);
-                            m_uiEndingTimer = 5000;
-                            ++m_uiEndingPhase;
-                            break;
-                        case 22:
-                            DoScriptText(SAY_ENDING_12_KING, me);
-                            //pTirion->SetReactState(REACT_AGGRESSIVE);
-                            //pTirion->AI()->AttackStart(me);
-                            //pFather->AI()->AttackStart(me);
-                            m_uiEndingTimer = 5000;
-                            ++m_uiEndingPhase;
-                            break;
-                        }
-                    } else m_uiEndingTimer -= uiDiff;
-                }
-
-                DoMeleeAttackIfReady();
-            }
-        private:
-            InstanceScript* pInstance;
-
-            uint32 m_uiEndingTimer;
-            uint32 m_uiEndingPhase;
-            uint32 m_uiPhase;
-            uint32 m_uiTirionSpawnTimer;
-            uint32 m_uiSummonShamblingHorrorTimer;
-            uint32 m_uiSummonDrudgeGhoulsTimer;
-            uint32 m_uiSummonShadowTrap;
-            uint32 m_uiInfestTimer;
-            uint32 m_uiNecroticPlagueTimer;
-            uint32 m_uiPlagueSiphonTimer;
-            uint32 m_uiBerserkTimer;
-            uint32 m_uiSummonValkyrTimer;
-            uint32 m_uiSoulReaperTimer;
-            uint32 m_uiDefileTimer;
-            uint32 m_uiHarvestSoulTimer;
-            uint32 m_uiSummonVileSpiritTimer;
-			uint32 m_uiFrostGramPortTimer;
-            uint32 m_uiPainandSufferingTimer;
-			uint32 m_uiQuakeTimer;
-            uint32 m_uiIcePulsSummonTimer;
-            uint32 m_uiSummonSpiritTimer;
-            uint32 m_uiRandomSpeechTimer;
-
-            bool TriggerSpawned;
-            bool TransitionPhase1;
-            bool TransitionPhase2;
-            bool TransitionPhase3;
-            bool bEnding;
-            bool bQuake;
-			bool bCast;
-
-            SummonList summons;
-
-        };
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new boss_the_lich_kingAI(pCreature);
-        }
-};
-
-class npc_tirion_icc : public CreatureScript
-{
-    public:
-        npc_tirion_icc() : CreatureScript("npc_tirion_icc") { }
-
-        struct npc_tirion_iccAI : public ScriptedAI
-        {
-            npc_tirion_iccAI(Creature* pCreature) : ScriptedAI(pCreature)
-            {
-                pInstance = pCreature->GetInstanceScript();
-                pTirion = me;
-            }
-
-            void Reset()
-            {
-                m_uiIntroTimer = 1000;
-                m_uiIntroPhase = 1;
-
-                bIntro = false;
-
-                me->SetReactState(REACT_PASSIVE);
-                me->SetSpeed(MOVE_RUN, 1.8f);
-                me->SetFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
-            }
-
-            void StartEvent()
-            {
-                bIntro = true;
-            }
-
-            void UpdateAI(const uint32 diff)
-            {
-                 if(!bIntro || !pInstance)
-                     return;
-
-                if(m_uiIntroTimer <= diff)
-                {
-                    switch(m_uiIntroPhase)
-                    {
-                    case 1:
-                        {
-                            pInstance->SetData(DATA_LICH_KING_EVENT, IN_PROGRESS);
-                            pLichKing->SetStandState(UNIT_STAND_STATE_STAND);
-                            pLichKing->AddUnitMovementFlag(MOVEMENTFLAG_WALKING);
-                            pLichKing->SetSpeed(MOVE_WALK, 1.2f);
-                            pLichKing->GetMotionMaster()->MovePoint(0, MovePos[0]);
-                            me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 375);
-                            m_uiIntroTimer = 3000;
-                            ++m_uiIntroPhase;
-                        }
-                    break;
-                    case 2:
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 1);
-                        DoScriptText(SAY_INTRO_1_KING, pLichKing);
-                        m_uiIntroTimer = 14000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 3:
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
-                        DoScriptText(SAY_INTRO_2_TIRION, me);
-                        m_uiIntroTimer = 9000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 4:
-                        DoScriptText(SAY_INTRO_3_KING, pLichKing);
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 392);
-                        m_uiIntroTimer = 3000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 5:
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 397);
-                        m_uiIntroTimer = 2000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 6:
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
-                        m_uiIntroTimer = 18000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 7:
-                        me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 397);
-                        DoScriptText(SAY_INTRO_4_TIRION, me);
-                        m_uiIntroTimer = 1000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 8:
-                        me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
-                        me->GetMotionMaster()->MovePoint(0, MovePos[3]);
-                        m_uiIntroTimer = 2000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 9:
-                        me->CastSpell(me, SPELL_ICEBLOCK_TRIGGER, true); 
-                        m_uiIntroTimer = 2000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 10:
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 1);
-                        DoScriptText(SAY_INTRO_5_KING, pLichKing);
-                        m_uiIntroTimer = 12000;
-                        ++m_uiIntroPhase;
-                        break;
-                    case 11:
-                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
-                        pLichKing->SetReactState(REACT_AGGRESSIVE);
-                        m_uiIntroTimer = 6000;
-                        ++m_uiIntroPhase;
-                        break;
-                    }
-                } else m_uiIntroTimer -= diff;
-
-                if(pInstance->GetData(DATA_LICH_KING_EVENT) != NOT_STARTED)
-                    me->RemoveFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);               
-                else              
-                    me->SetFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);                
-            }
-        private:
-            InstanceScript* pInstance;
-
-            uint32 m_uiIntroTimer;
-            uint32 m_uiIntroPhase;
-
-            bool bIntro;
-        };
-
-        bool OnGossipHello(Player* pPlayer, Creature* pCreature)
-        {
-            pPlayer->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_START_EVENT, GOSSIP_SENDER_MAIN, 999999);
-            pPlayer->SEND_GOSSIP_MENU(10600, pCreature->GetGUID());
-
-            return true;
-        }
-
-        bool OnGossipSelect(Player* pPlayer, Creature* pCreature, uint32 /*uiSender*/, uint32 uiAction)
-        {
-            if (uiAction == 999999)
-            {
-                CAST_AI(npc_tirion_icc::npc_tirion_iccAI, pCreature->AI())->StartEvent();
-                pCreature->RemoveFlag(UNIT_NPC_FLAGS,UNIT_NPC_FLAG_GOSSIP);
-                pPlayer->CLOSE_GOSSIP_MENU();
-            }
-            return true;
-        }
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new npc_tirion_iccAI(pCreature);
-        }
-};
-
-class npc_ice_puls_icc : public CreatureScript
-{
-    public:
-        npc_ice_puls_icc() : CreatureScript("npc_ice_puls_icc") { }
-
-        struct npc_ice_puls_iccAI : public ScriptedAI
-        {
-            npc_ice_puls_iccAI(Creature* pCreature) : ScriptedAI(pCreature) { }
-
-            void Reset()
-            {
-                m_uiIcePulseTimer = 3000;
-
-                if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
-                {
-                    me->AddThreat(pTarget, 500000.0f);
-                    me->GetMotionMaster()->MoveChase(pTarget);
-                }
-            }
-
-            void EnterCombat(Unit* /*who*/)
-            {
-                DoZoneInCombat();
-            }
-
-            void UpdateAI(const uint32 uiDiff)
-            {
-                if (!UpdateVictim())
-                    return;
-
-                if (m_uiIcePulseTimer < uiDiff)
-                {
-                    DoCast(me->getVictim(), SPELL_ICE_PULSE);
-                    m_uiIcePulseTimer = 3000;
-                } else m_uiIcePulseTimer -= uiDiff;
-
-                if (me->IsWithinDistInMap(me->getVictim(), 3))
-                    DoCast(me, SPELL_ICE_BURST);
-            }
-        private:
-            uint32 m_uiIcePulseTimer;
-        };
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new npc_ice_puls_iccAI(pCreature);
-        }
-};
-
-class npc_valkyr_icc : public CreatureScript
-{
-    public:
-        npc_valkyr_icc() : CreatureScript("npc_valkyr_icc") { }
-
-        struct npc_valkyr_iccAI : public ScriptedAI
-        {
-            npc_valkyr_iccAI(Creature* pCreature) : ScriptedAI(pCreature), vehicle(pCreature->GetVehicleKit())
-            {
-                assert(vehicle);
-            }
-
-            void Reset()
-            {
-                me->SetFlying(true);
-                m_uiGrabTimer = 2000;
-                m_uiMovementTimer = 3000;
-                m_uiFallPlayerTimer = 10000;
-                assert(vehicle);
-                me->GetVehicleKit();
-                InVehicle = false;
-                OutVehicle = false;
-            }
-
-            void EnterCombat(Unit* /*who*/)
-            {
-                DoZoneInCombat();
-            }
-
-            void UpdateAI(const uint32 uiDiff)
-            {
-                if (!UpdateVictim())
-                    return;
-
-                if (m_uiGrabTimer < uiDiff)
-                {
-                    if(InVehicle == false)
-                    {
-                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
-                        {
-                            pTarget->EnterVehicle(vehicle);
-                            InVehicle = true;
-                            DoCast(me, SPELL_WINGS_OF_THE_DAMNED);
-                            if (IsHeroic())
-                                DoCast(pTarget, SPELL_LIFE_SIPHON);
-                        }
-                    }
-                    m_uiGrabTimer = 120000;
-                } else m_uiGrabTimer -= uiDiff;
-
-                if (m_uiMovementTimer < uiDiff)
-                {
-                    me->GetMotionMaster()->MovePoint(0, MovePos[4]);
-                    m_uiMovementTimer = 120000;
-                } else m_uiMovementTimer -= uiDiff;
-
-                if (m_uiFallPlayerTimer < uiDiff)
-                {
-                    if(!OutVehicle)
-                    {
-                        vehicle->RemoveAllPassengers();
-                        OutVehicle = true;
-                    }
-                    m_uiFallPlayerTimer = 120000;
-                } else m_uiFallPlayerTimer -= uiDiff;
-            }
-        private:
-            uint32 m_uiGrabTimer;
-            uint32 m_uiMovementTimer;
-            uint32 m_uiFallPlayerTimer;
-
-            bool InVehicle;
-            bool OutVehicle;
-
-            Vehicle* vehicle;
-        };
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new npc_valkyr_iccAI(pCreature);
-        }
-};
-
-class npc_ghoul_icc : public CreatureScript
-{
-    public:
-        npc_ghoul_icc() : CreatureScript("npc_ghoul_icc") { }
-
-        struct npc_ghoul_iccAI : public ScriptedAI
-        {
-            npc_ghoul_iccAI(Creature *pCreature) : ScriptedAI(pCreature) { }
-
-            void Reset()
-            {
-                m_uiLifeTimer = 1000;
-                m_uiAggroTimer = 4000;
-
-                IsLife = false;
-                IsAggroTimer = false;
-            }
-
-            void EnterCombat(Unit* /*who*/)
-            {
-                DoZoneInCombat();
-            }
-
-            void UpdateAI(const uint32 uiDiff)
-            {
-                if (!UpdateVictim())
-                    return;
-
-                if (m_uiLifeTimer < uiDiff && !IsLife)
-                {
-                    me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 449);
-                    IsLife = true;
-                } else m_uiLifeTimer -= uiDiff;
-
-                if (m_uiAggroTimer < uiDiff && !IsAggroTimer)
-                {
-                    me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
-                    IsAggroTimer = true;
-                } else m_uiAggroTimer -= uiDiff;
-            }
-        private:
-            uint32 m_uiLifeTimer;
-            uint32 m_uiAggroTimer;
-
-            bool IsLife;
-            bool IsAggroTimer;
-        };
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new npc_ghoul_iccAI(pCreature);
-        }
-};
-
-class npc_defile_icc : public CreatureScript
-{
-    public:
-        npc_defile_icc() : CreatureScript("npc_defile_icc") { }
-
-        struct npc_defile_iccAI : public Scripted_NoMovementAI
-        {
-            npc_defile_iccAI(Creature* pCreature) : Scripted_NoMovementAI(pCreature)
-            {
-                me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_DISABLE_MOVE);
-            }
-
-            void Reset()
-            {
-                me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
-                m_uiDespawnTimer = 60000;
-                DoCast(me, SPELL_DEFILE);
-
-                Despawnd = false;
-            }
-
-            void UpdateAI(const uint32 uiDiff)
-            {
-                if (m_uiDespawnTimer < uiDiff && !Despawnd)
-                {
-                    me->ForcedDespawn();
-                    Despawnd = true;
-                } else m_uiDespawnTimer -= uiDiff;
-            }
-        private:
-            uint32 m_uiDespawnTimer;
-
-            bool Despawnd;
-        };
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new npc_defile_iccAI(pCreature);
-        }
-};
-
-class npc_vile_spirit_icc : public CreatureScript
-{
-    public:
-        npc_vile_spirit_icc() : CreatureScript("npc_vile_spirit_icc") { }
-
-        struct npc_vile_spirit_iccAI : public ScriptedAI
-        {
-            npc_vile_spirit_iccAI(Creature* pCreature) : ScriptedAI(pCreature) { }
-
-            void Reset()
-            {
-                m_uiMoveTimer = 15000;
-                bStartMove = false;
-
-                DoStartNoMovement(me->getVictim());
-
-                if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100, true))
-                    me->AddThreat(pTarget, 100000.0f);
-            }
-
-            void UpdateAI(const uint32 uiDiff)
-            {
-                if (!bStartMove && m_uiMoveTimer < uiDiff)
-                {
-                    DoStartMovement(me->getVictim());
-                    bStartMove = true;
-                    m_uiMoveTimer = 15000;
-                } else m_uiMoveTimer -= uiDiff;
-
-                if(bStartMove && me->IsWithinDistInMap(me, 2.0f, true))
-                    DoCast(me->getVictim(), SPELL_BURST, true);
-            }
-        private:
-            uint32 m_uiShriekTimer;
-            bool bStartMove;
-            uint32 m_uiMoveTimer;
-        };
-
-        CreatureAI* GetAI(Creature* pCreature) const
-        {
-            return new npc_vile_spirit_iccAI(pCreature);
-        }
-};
-
-class spell_lich_king_necrotic_plague : public SpellScriptLoader
-{
-    public:
-        spell_lich_king_necrotic_plague() : SpellScriptLoader("spell_lich_king_necrotic_plague") { } //70338
-
-
-        class spell_lich_king_necrotic_plague_AuraScript : public AuraScript
-        {
-            PrepareAuraScript(spell_lich_king_necrotic_plague_AuraScript)
-
-            void ExtraEffect(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
-            {
-                 if (InstanceScript* instance = aurApp->GetBase()->GetCaster()->GetInstanceScript())
-                    if (Creature* lichking = Unit::GetCreature(*aurApp->GetTarget(), instance->GetData64(DATA_LICH_KING)))
-                        if(lichking->isAlive())
-                            lichking->CastSpell(lichking, SPELL_PLAGUE_SIPHON, true);
-
-                if (Unit* previous = aurApp->GetBase()->GetCaster())
-                
-                    previous->CastSpell(previous, SPELL_NECROTIC_PLAGUE_IMMUNITY, true);
-            
-                if (Unit* target = aurApp->GetTarget())
-					if (Aura* plague = target->AddAura(SPELL_NECROTIC_PLAGUE, target))
-						 plague->SetStackAmount(plague->GetStackAmount() + 1);
-		}
-            void Register()
-            {
-                OnEffectRemove += AuraEffectRemoveFn(spell_lich_king_necrotic_plague_AuraScript::ExtraEffect, EFFECT_0, SPELL_AURA_PERIODIC_DAMAGE, AURA_EFFECT_HANDLE_REAL);
-            }
-        };
-
-        AuraScript* GetAuraScript() const
-        {
-            return new spell_lich_king_necrotic_plague_AuraScript();
-        }
-};
-
-class spell_lich_king_infection : public SpellScriptLoader
-{
-    public:
-        spell_lich_king_infection() : SpellScriptLoader("spell_lich_king_infection") { } //70541
-
-
-        class spell_lich_king_infection_AuraScript : public AuraScript
-        {
-            PrepareAuraScript(spell_lich_king_infection_AuraScript)
-
-            void OnApplyInfection(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
-            {
-                if (Unit* sick = aurApp->GetBase()->GetCaster())
-                    if(sick->isAlive() && sick->GetHealthPct() > 90)
-                        sick->RemoveAurasDueToSpell(SPELL_INFEST);
-            }
-
-            void Register()
-            {
-                OnEffectApply += AuraEffectApplyFn(spell_lich_king_infection_AuraScript::OnApplyInfection, EFFECT_0, SPELL_AURA_PERIODIC_DAMAGE, AURA_EFFECT_HANDLE_REAL);
-            }
-        };
-
-        AuraScript* GetAuraScript() const
-        {
-            return new spell_lich_king_infection_AuraScript();
-        }
-};
-
-class spell_lich_king_valkyr_summon : public SpellScriptLoader
-{
-    public:
-        spell_lich_king_valkyr_summon() : SpellScriptLoader("spell_lich_king_valkyr_summon") { } //74361
-
-
-        class spell_lich_king_valkyr_summon_AuraScript : public AuraScript
-        {
-            PrepareAuraScript(spell_lich_king_valkyr_summon_AuraScript);
-
-            void HandleTriggerSpell(AuraEffect const* aurEff, AuraApplication const* aurApp)
-            {
-                PreventDefaultAction();
-                if (Unit* caster = aurApp->GetBase()->GetCaster())
-                {
-                    uint32 triggerSpellId = GetSpellProto()->EffectTriggerSpell[aurEff->GetEffIndex()];
-                    float x, y, z;
-                    caster->GetPosition(x, y, z);
-                    x += 10.0f * cosf(caster->GetOrientation());
-                    y += 10.0f * sinf(caster->GetOrientation());
-                    caster->CastSpell(x, y, z + 10, triggerSpellId, true, NULL, NULL, GetCasterGUID(), caster);
-                }
-            }
-
-            void Register()
-            {
-                OnEffectPeriodic += AuraEffectPeriodicFn(spell_lich_king_valkyr_summon_AuraScript::HandleTriggerSpell, EFFECT_0, SPELL_AURA_PERIODIC_TRIGGER_SPELL);
-            }
-        };
-
-
-        AuraScript* GetAuraScript() const
-        {
-            return new spell_lich_king_valkyr_summon_AuraScript();
-        }
-};
-
-class spell_lich_king_quake : public SpellScriptLoader
-{
-    public:
-        spell_lich_king_quake() : SpellScriptLoader("spell_lich_king_quake") { } //72262
-
-
-        class spell_lich_king_quake_AuraScript : public AuraScript
-        {
-            PrepareAuraScript(spell_lich_king_quake_AuraScript)
-
-            void OnApply(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
-            {
-                if (InstanceScript* instance = aurApp->GetTarget()->GetInstanceScript())
-                    if (GameObject* floor = instance->instance->GetGameObject(instance->GetData64(DATA_PLATFORM)))
-                        floor->TakenDamage(1000000);
-            }
-
-            void Register()
-            {
-                OnEffectApply += AuraEffectApplyFn(spell_lich_king_quake_AuraScript::OnApply, EFFECT_0, SPELL_AURA_DUMMY, AURA_EFFECT_HANDLE_REAL);
-            }
-        };
-
-        AuraScript* GetAuraScript() const
-        {
-            return new spell_lich_king_quake_AuraScript();
-        }
-};
-
-void AddSC_boss_lichking()
-{
-    new boss_the_lich_king();
-    new npc_tirion_icc();
-    new npc_ice_puls_icc();
-    new npc_valkyr_icc();
-    new npc_ghoul_icc();
-    new npc_defile_icc();
-    new npc_vile_spirit_icc();
-	new spell_lich_king_necrotic_plague();
-	new spell_lich_king_infection();
-	new spell_lich_king_valkyr_summon();
-	new spell_lich_king_quake();
-}
+/*
+* Copyright (C) 2009 - 2010 TrinityCore <http://www.trinitycore.org/>
+*
+* This program is free software; you can redistribute it and/or modify
+* it under the terms of the GNU General Public License as published by
+* the Free Software Foundation; either version 2 of the License, or
+* (at your option) any later version.
+*
+* This program is distributed in the hope that it will be useful,
+* but WITHOUT ANY WARRANTY; without even the implied warranty of
+* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
+* GNU General Public License for more details.
+*
+* You should have received a copy of the GNU General Public License
+* along with this program; if not, write to the Free Software
+* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+*/
+
+#include "ObjectMgr.h"
+#include "ScriptMgr.h"
+#include "ScriptedCreature.h"
+#include "SpellScript.h"
+#include "SpellAuraEffects.h"
+#include "icecrown_citadel.h"
+
+/*
+//Speaking to Tirion Fordring to begin the fight
+Long have I waited for this day, hero. Are you and your allies prepared to bring the Lich King to justice? We charge on your command!
+ We are prepared, Highlord. Let us battle for the fate of Azeroth! For the light of dawn!
+*/
+#define GOSSIP_START_EVENT "We are prepared, Highlord. Let us battle for the fate of Azeroth! For the light of dawn!"
+
+enum Yells
+{
+    SAY_INTRO_1_KING         = -1810001,
+    SAY_INTRO_2_TIRION       = -1810002,
+    SAY_INTRO_3_KING         = -1810003,
+    SAY_INTRO_4_TIRION       = -1810004,
+    SAY_INTRO_5_KING         = -1810005,
+    SAY_AGGRO                = -1810006,
+    SAY_REMORSELESS_WINTER   = -1810007,
+    SAY_RANDOM_1             = -1810008,
+    SAY_RANDOM_2             = -1810009,
+    SAY_KILL_1               = -1810010,
+    SAY_KILL_2               = -1810011,
+    SAY_BERSERK              = -1810012,
+    SAY_ENDING_1_KING        = -1810013,
+    SAY_ENDING_2_KING        = -1810014,
+    SAY_ENDING_3_KING        = -1810015,
+    SAY_ENDING_4_KING        = -1810016,
+    SAY_ENDING_5_TIRION      = -1810017,
+    SAY_ENDING_6_KING        = -1810018,
+    SAY_ENDING_8_TIRION      = -1810020,
+    SAY_ENDING_9_FATHER      = -1810021,
+    SAY_ENDING_10_TIRION     = -1810022,
+    SAY_ENDING_11_FATHER     = -1810023,
+    SAY_ENDING_12_KING       = -1810024,
+    SAY_DEATH_KING           = -1810025,
+    SAY_ESCAPE_FROSTMOURNE   = -1810026,
+    SAY_HARVEST_SOUL         = -1810027,
+    SAY_DEVOURED_FROSTMOURNE = -1810028,
+    SAY_SUMMON_VALKYR        = -1810029,
+    SAY_BROKEN_ARENA         = -1810030,
+    SAY_10_PROZENT           = -1810031,
+    SAY_EMOTE_DEFILE         = -1810032,
+};
+
+enum Spells
+{
+    SPELL_SUMMON_SHAMBLING_HORROR    = 70372,
+    SPELL_SUMMON_DRUDGE_GHOULS       = 70359,
+    SPELL_SUMMON_ICE_SPEHERE         = 69103,
+    SPELL_SUMMON_RAGING_SPIRIT       = 69200,
+    SPELL_SUMMON_VALKYR              = 74361,
+    SPELL_SUMMON_DEFILE              = 72762,
+    SPELL_SUMMON_VILE_SPIRIT         = 70498,
+    SPELL_SUMMON_BROKEN_FROSTMOURNE  = 72406,
+    SPELL_SUMMON_SHADOW_TRAP         = 73539,
+    SPELL_INFEST                     = 70541,
+    SPELL_NECROTIC_PLAGUE            = 70338,
+    SPELL_NECROTIC_PLAGUE_IMMUNITY   = 72846,
+    SPELL_PLAGUE_SIPHON              = 74074,
+    SPELL_REMORSELES_WINTER          = 68981,
+    SPELL_PAIN_AND_SUFFERING         = 72133,
+    SPELL_WINGS_OF_THE_DAMNED        = 74352,
+    SPELL_SOUL_REAPER                = 69409,
+    SPELL_SOUL_REAPER_HASTE_AURA     = 69410,
+    SPELL_HARVEST_SOUL_TELEPORT      = 71372,
+    SPELL_HARVEST_SOULS              = 74325,
+    SPELL_QUAKE                      = 72262,
+    SPELL_CHANNEL_KING               = 71769,
+    SPELL_BROKEN_FROSTMOURNE         = 72398,
+    SPELL_BOOM_VISUAL                = 72726,
+    SPELL_ICEBLOCK_TRIGGER           = 71614,
+    SPELL_TIRION_LIGHT               = 71797,
+    SPELL_FROSTMOURNE_TRIGGER        = 72405,
+    SPELL_DISENGAGE                  = 61508,
+    SPELL_FURY_OF_FROSTMOURNE        = 72350,
+    SPELL_REVIVE_VISUAL              = 37755,
+    SPELL_REVIVE                     = 72429,
+    SPELL_REVIVE_EFFECT              = 72423,
+    SPELL_CLONE_PLAYER               = 57507,
+    SPELL_DEFILE                     = 72743,
+    SPELL_ICE_PULSE                  = 69091,
+    SPELL_ICE_BURST                  = 69108,
+    SPELL_LIFE_SIPHON                = 73783,
+    SPELL_SOUL_SHRIEK                = 69242,
+    SPELL_WHOCKVAWE                  = 72149,
+    SPELL_ENRAGE                     = 72143,
+    SPELL_BURST                      = 70503,
+    SPELL_VILE_SPIRIT_DISTANCE_CHECK = 70502,
+    SPELL_ICE_BURST_DISTANCE_CHECK   = 69109,
+    SPELL_VILE_SPIRIT_ACTIVE         = 72130
+
+    //SPELL_70501 //Vile Spirit Move Target Search
+};
+
+enum ePoints
+{
+    POINT_PLATFORM_CENTRE            = 3659701,
+    POINT_PLARFORM_END               = 3659702
+};
+
+struct Position MovePos[]=
+{
+    {461.792633f, -2125.855957f, 1040.860107f, 0.0f}, // move
+    {503.156525f, -2124.516602f, 1040.860107f, 0.0f}, // move ending
+    {490.110779f, -2124.989014f, 1040.860352f, 0.0f}, // move tirion frostmourne
+    {478.333466f, -2124.618652f, 1040.859863f, 0.0f}, // move tirion attack
+    {498.004486f, 2201.573486f, 1046.093872f, 0.0f}  // move valkyr
+};
+
+//TODO:
+//Need fixed:
+//raging spirit aura
+//raging spirit cast 69198
+//69200 - must be aura with duration: 5 seconds
+
+/*struct Locations
+{
+    float x,y,z;
+};
+
+static Locations TeleportPoint[]=
+{
+    {959.996f, 212.576f, 193.843f},
+    {932.537f, 231.813f, 193.838f},
+    {958.675f, 254.767f, 193.822f},
+    {946.955f, 201.316f, 192.535f},
+    {944.294f, 149.676f, 197.551f},
+    {930.548f, 284.888f, 193.367f},
+    {965.997f, 278.398f, 195.777f},
+};*/
+
+Creature* pLichKing;
+Creature* pTirion;
+Creature* pFather;
+Creature* pFrostmourne;
+Creature* pSafeZone;
+
+class boss_the_lich_king : public CreatureScript
+{
+    public:
+        boss_the_lich_king() : CreatureScript("boss_the_lich_king") { }
+
+        struct boss_the_lich_kingAI : public BossAI
+        {
+            boss_the_lich_kingAI(Creature* pCreature) : BossAI(pCreature, DATA_LICH_KING), summons(me)
+            {
+                pInstance = me->GetInstanceScript();
+                pLichKing = me;
+            }
+
+            void Reset()
+            {
+                me->SetReactState(REACT_PASSIVE);
+                me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+
+                m_uiPhase = 1;
+                m_uiRandomSpeechTimer = 33000;
+                m_uiBerserkTimer = 900000;
+                m_uiSummonShamblingHorrorTimer = 20000;
+                m_uiSummonDrudgeGhoulsTimer = 30000;
+                m_uiInfestTimer = 30000;
+                m_uiNecroticPlagueTimer = !bCast ? 30000 : 30000000;
+                m_uiTirionSpawnTimer = 5000;
+                m_uiIcePulsSummonTimer = 10000;
+                m_uiPainandSufferingTimer = 10000;
+                m_uiSummonSpiritTimer = 20000;
+                m_uiSummonValkyrTimer = 5000;
+                m_uiSoulReaperTimer = 30000;
+                m_uiDefileTimer = 25000;
+                m_uiInfestTimer = 40000;
+                m_uiSummonVileSpiritTimer = 30000;
+                m_uiHarvestSoulTimer = 70000;
+                m_uiSummonShadowTrap = 20000;
+                m_uiEndingTimer = 1000;
+                m_uiEndingPhase = 1;
+
+                TriggerSpawned = false;
+                bEnding = false;
+                bCast = false;
+
+                if(!pInstance)
+                    return;
+
+                pInstance->SetData(DATA_LICH_KING_EVENT, NOT_STARTED);
+                pInstance->SetData(DATA_BEEN_WAITING, DONE);
+                pInstance->SetData(DATA_NECK_DEEP, DONE);
+
+                summons.DespawnAll();
+
+                me->SetSpeed(MOVE_RUN, 1.8f);
+                me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_DISARMED);
+
+                if (me->GetMotionMaster()->GetCurrentMovementGeneratorType() == POINT_MOTION_TYPE)
+                    me->GetMotionMaster()->MovementExpired();
+
+                if(SpellEntry* spellRevive = GET_SPELL(SPELL_SUMMON_DEFILE))
+                    spellRevive->DurationIndex = 3;
+                if(SpellEntry* spell = GET_SPELL(SPELL_ICEBLOCK_TRIGGER))
+                    spell->Targets = 6; //target chain damage
+                if(SpellEntry* spell = GET_SPELL(SPELL_SOUL_REAPER_HASTE_AURA))
+                    spell->Targets = 1;
+            }
+
+            void EnterCombat(Unit* /*pWho*/)
+            {
+                DoScriptText(SAY_AGGRO, me);
+
+                if(pInstance)
+                    pInstance->SetData(DATA_LICH_KING_EVENT, IN_PROGRESS);
+            }
+
+            void JustDied(Unit* /*pKiller*/)
+            {
+                if(!pInstance)
+                    return;
+
+                DoScriptText(SAY_DEATH_KING, me);
+                pInstance->SetData(DATA_LICH_KING_EVENT, DONE);
+                if(pInstance->GetData(DATA_BEEN_WAITING) == DONE)
+                    pInstance->DoCompleteAchievement(RAID_MODE(ACHIEV_BEEN_WAITING_A_LONG_TIME_FOR_THIS_10,ACHIEV_BEEN_WAITING_A_LONG_TIME_FOR_THIS_25));
+                if(pInstance->GetData(DATA_NECK_DEEP) == FAIL)
+                    pInstance->DoCompleteAchievement(RAID_MODE(ACHIEV_NECK_DEEP_IN_VILE_10,ACHIEV_NECK_DEEP_IN_VILE_25));
+
+                summons.DespawnAll();
+
+                PlayerCinematic();
+            }
+
+            void MovementInform(uint32 type, uint32 id)
+            {
+                if(type != POINT_MOTION_TYPE)
+                    return;
+
+                if(id == POINT_PLATFORM_CENTRE)
+                {
+                    DoScriptText(SAY_REMORSELESS_WINTER, me);
+                    DoCast(me, SPELL_REMORSELES_WINTER);
+                    me->GetMotionMaster()->MovementExpired();
+                }
+            }
+
+            void PlayerCinematic()
+            {
+                Map::PlayerList const &PlList = me->GetMap()->GetPlayers();
+
+                if (PlList.isEmpty())
+                    return;
+
+                for (Map::PlayerList::const_iterator i = PlList.begin(); i != PlList.end(); ++i)
+                {
+                    if (Player* pPlayer = i->getSource())
+                    {
+                        if(pPlayer)
+                        {
+                            pPlayer->SendMovieStart(16);
+                        }
+                    }
+                }
+            }
+
+            void JustReachedHome()
+            {
+                if(pInstance)
+                    pInstance->SetData(DATA_LICH_KING_EVENT, FAIL);
+
+                summons.DespawnAll();
+            }
+
+            void KilledUnit(Unit* victim)
+            {
+                if(!bEnding)
+                {
+                    if (victim->GetTypeId() == TYPEID_PLAYER)
+                    {
+                        switch(rand()%1)
+                        {
+                            case 0: DoScriptText(SAY_KILL_1, me); break;
+                            case 1: DoScriptText(SAY_KILL_2, me); break;
+                        }
+                    }
+                }
+            }
+
+            void JustSummoned(Creature* summoned)
+            {
+                if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                    summoned->AI()->AttackStart(pTarget);
+
+                summons.Summon(summoned);
+
+                switch(summoned->GetEntry())
+                {
+                    case CREATURE_ICE_SPHERE:
+                        DoCast(summoned, SPELL_ICE_BURST_DISTANCE_CHECK);
+                        DoCast(summoned, SPELL_ICE_PULSE);
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                        {
+                            me->AI()->AttackStart(pTarget);
+                            me->GetMotionMaster()->MoveChase(pTarget);
+                        }
+                        break;
+                    case CREATURE_DEFILE:
+                        DoCast(summoned, SPELL_DEFILE);
+                        summoned->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+                        break;
+                }
+            }
+
+            void Phasenswitch()
+            {
+                me->SetReactState(REACT_PASSIVE);
+                me->AttackStop();
+                me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+                SetCombatMovement(false);
+                me->GetMotionMaster()->MovePoint(POINT_PLATFORM_CENTRE, MovePos[1]);
+            }
+
+            void NextPhase() //caled after cast winter
+            {
+                m_uiPhase = m_uiPhase == 2 ? 3 : 5;
+                me->SetReactState(REACT_AGGRESSIVE);
+                SetCombatMovement(true);
+                me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+            }
+
+            void DamageTaken(Unit* /*done_by*/, uint32& /*damage*/)
+            {
+                switch(m_uiPhase)
+                {
+                case 1:
+                    if(HealthAbovePct(71))
+                        return;
+                        m_uiPhase = 2;
+                        Phasenswitch();
+                    break;
+                case 3:
+                    if(HealthAbovePct(41))
+                        return;
+                        m_uiPhase = 4;
+                        Phasenswitch();
+                    break;
+                }
+
+                if(!HealthAbovePct(12) && !TriggerSpawned)
+                {
+                    pSafeZone = me->SummonCreature(CREATURE_TRIGGER, me->GetPositionX(), me->GetPositionY(), me->GetPositionZ(), 0, TEMPSUMMON_CORPSE_DESPAWN, 360000);
+                    pSafeZone->AI()->AttackStart(me);
+                    pSafeZone->SetDisplayId(MODEL_INVISIBLE);
+                    TriggerSpawned = true;
+                }
+
+                if(!HealthAbovePct(11) && !bEnding)
+                    bEnding = true;
+            }
+
+            void UpdateAI(const uint32 uiDiff)
+            {
+                if (!UpdateVictim() || !CheckInRoom())
+                    return;
+
+                if(!bEnding)
+                {
+                    if (m_uiRandomSpeechTimer < uiDiff)
+                    {
+                        DoScriptText(RAND(SAY_RANDOM_1,SAY_RANDOM_2), me);
+                        m_uiRandomSpeechTimer = 33000;
+                    } else m_uiRandomSpeechTimer -= uiDiff;
+
+                    if (m_uiBerserkTimer < uiDiff)
+                    {
+                        DoScriptText(SAY_BERSERK, me);
+                        DoCast(me, SPELL_BERSERK);
+                        m_uiBerserkTimer = 900000;
+                    } else m_uiBerserkTimer -= uiDiff;
+                }
+
+                if(m_uiPhase == 1)
+                {
+                    if (IsHeroic())
+                    {
+                        if (m_uiSummonShadowTrap < uiDiff)
+                        {
+                            if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                                DoCast(pTarget, SPELL_SUMMON_SHADOW_TRAP, true);
+                            m_uiSummonShadowTrap = 30000;
+                        } else m_uiSummonShadowTrap -= uiDiff;
+                    }
+
+                    if (m_uiInfestTimer < uiDiff)
+                    {
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_INFEST);
+                        m_uiInfestTimer = 30000;
+                    } else m_uiInfestTimer -= uiDiff;
+
+                    if (m_uiSummonDrudgeGhoulsTimer < uiDiff)
+                    {
+                        DoCast(SPELL_SUMMON_DRUDGE_GHOULS);
+                        m_uiSummonDrudgeGhoulsTimer = 20000;
+                    } else m_uiSummonDrudgeGhoulsTimer -= uiDiff;
+
+                    if (m_uiSummonShamblingHorrorTimer < uiDiff)
+                    {
+                        DoCast(SPELL_SUMMON_SHAMBLING_HORROR);
+                        m_uiSummonShamblingHorrorTimer = 30000;
+                    } else m_uiSummonShamblingHorrorTimer -= uiDiff;
+
+                    if (m_uiNecroticPlagueTimer < uiDiff)
+                    {
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_NECROTIC_PLAGUE);
+                        m_uiNecroticPlagueTimer = !bCast ? 30000 : 30000000;
+                    } else m_uiNecroticPlagueTimer -= uiDiff;
+                }
+
+                if(m_uiPhase == 2) //transition phase 1
+                {
+                    if (m_uiSummonSpiritTimer < uiDiff)
+                    {
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_SUMMON_RAGING_SPIRIT);
+                        m_uiSummonSpiritTimer = 20000;
+                    } else m_uiSummonSpiritTimer -= uiDiff;
+
+                    if (m_uiIcePulsSummonTimer < uiDiff)
+                    {
+                        DoCast(SPELL_SUMMON_ICE_SPEHERE);
+                        m_uiIcePulsSummonTimer = 15000;
+                    } else m_uiIcePulsSummonTimer -= uiDiff;
+
+                    if (m_uiPainandSufferingTimer < uiDiff)
+                    {
+                        DoCast(SPELL_PAIN_AND_SUFFERING);
+                        m_uiPainandSufferingTimer = 2000;
+                    } else m_uiPainandSufferingTimer -= uiDiff;
+                }
+
+                if(m_uiPhase == 3)
+                {
+                    if (m_uiDefileTimer < uiDiff)
+                    {
+                        DoScriptText(SAY_EMOTE_DEFILE, me);
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_SUMMON_DEFILE);
+                        m_uiDefileTimer = 20000;
+                    } else m_uiDefileTimer -= uiDiff;
+
+                    if (m_uiSummonValkyrTimer < uiDiff)
+                    {
+                        DoScriptText(SAY_SUMMON_VALKYR, me);
+                        DoCast(SPELL_SUMMON_VALKYR);
+                        m_uiSummonValkyrTimer = 35000;
+                        m_uiDefileTimer = 5000; //cast defile after cast valkyr summon
+                    } else m_uiSummonValkyrTimer -= uiDiff;
+
+                    if (m_uiSoulReaperTimer < uiDiff)
+                    {
+                        DoCastVictim(SPELL_SOUL_REAPER);
+                        DoCast(SPELL_SOUL_REAPER_HASTE_AURA);
+                        m_uiSoulReaperTimer = 30000;
+                    } else m_uiSoulReaperTimer -= uiDiff;
+
+                    if (m_uiInfestTimer < uiDiff)
+                    {
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_INFEST);
+                        m_uiInfestTimer = 30000;
+                    } else m_uiInfestTimer -= uiDiff;
+                }
+
+                if(m_uiPhase == 4) //transition phase 2
+                {
+                    if (m_uiSummonSpiritTimer < uiDiff)
+                    {
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_SUMMON_RAGING_SPIRIT);
+                        m_uiSummonSpiritTimer = 15000;
+                    } else m_uiSummonSpiritTimer -= uiDiff;
+
+                    if (m_uiIcePulsSummonTimer < uiDiff)
+                    {
+                        DoCast(SPELL_SUMMON_ICE_SPEHERE);
+                        m_uiIcePulsSummonTimer = 15000;
+                    } else m_uiIcePulsSummonTimer -= uiDiff;
+
+                    if (m_uiPainandSufferingTimer < uiDiff)
+                    {
+                        DoCast(SPELL_PAIN_AND_SUFFERING);
+                        m_uiPainandSufferingTimer = 3000;
+                    } else m_uiPainandSufferingTimer -= uiDiff;
+                }
+
+                if(m_uiPhase == 5)
+                {
+                    if (m_uiSummonVileSpiritTimer < uiDiff)
+                    {
+                        DoCast(SPELL_SUMMON_VILE_SPIRIT);
+                        m_uiSummonVileSpiritTimer = 30000;
+                    } else m_uiSummonVileSpiritTimer -= uiDiff;
+
+                    if (m_uiHarvestSoulTimer < uiDiff)
+                    {
+                        DoScriptText(SAY_HARVEST_SOUL, me);
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_HARVEST_SOULS);
+                        m_uiHarvestSoulTimer = 70000;
+                    } else m_uiHarvestSoulTimer -= uiDiff;
+
+                    if (m_uiSoulReaperTimer < uiDiff)
+                    {
+                        DoCastVictim(SPELL_SOUL_REAPER);
+                        DoCast(me, SPELL_SOUL_REAPER_HASTE_AURA);
+                        m_uiSoulReaperTimer = 30000;
+                    } else m_uiSoulReaperTimer -= uiDiff;
+
+                    if (m_uiDefileTimer < uiDiff)
+                    {
+                        if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                            DoCast(pTarget, SPELL_SUMMON_DEFILE);
+                        m_uiDefileTimer = 20000;
+                    } else m_uiDefileTimer -= uiDiff;
+                }
+
+                if(bEnding)
+                {
+                    if (m_uiEndingTimer <= uiDiff)
+                    {
+                        switch(m_uiEndingPhase)
+                        {
+                        case 1:
+                            me->GetMotionMaster()->MoveIdle();
+                            me->SetReactState(REACT_PASSIVE);
+                            me->AttackStop();
+                            me->CastStop();
+                            DoResetThreat();
+                            DoScriptText(SAY_10_PROZENT, me);
+                            DoCastAOE(SPELL_FURY_OF_FROSTMOURNE);
+                            m_uiEndingTimer = 15000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 2:
+                            DoScriptText(SAY_ENDING_1_KING, me);
+                            m_uiEndingTimer = 24000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 3:
+                            DoScriptText(SAY_ENDING_2_KING, me);
+                            m_uiEndingTimer = 25000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 4:
+                            me->GetMotionMaster()->MovePoint(0, MovePos[1]);
+                            m_uiEndingTimer = 4000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 5:
+                            DoCast(me, SPELL_CHANNEL_KING);
+                            DoScriptText(SAY_ENDING_3_KING, me);
+                            m_uiEndingTimer = 26000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 6:
+                            DoScriptText(SAY_ENDING_4_KING, me);
+                            m_uiEndingTimer = 9000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 7:
+                            DoScriptText(SAY_ENDING_5_TIRION, pTirion);
+                            m_uiEndingTimer = 9000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 8:
+                            DoCast(pTirion, SPELL_TIRION_LIGHT);
+                            m_uiEndingTimer = 5000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 9:
+                            pTirion->RemoveAurasDueToSpell(SPELL_ICEBLOCK_TRIGGER);
+                            m_uiEndingTimer = 2000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 10:
+                            pTirion->GetMotionMaster()->MovePoint(0, MovePos[2]);
+                            m_uiEndingTimer = 1000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 11:
+                            pTirion->GetMotionMaster()->MoveJump(517.482910f, -2124.905762f, 1040.861328f, 10.0f, 15.0f); //pTirion->JumpTo(pFrostmourne, 15.0f);
+                            pTirion->SetUInt32Value(UNIT_NPC_EMOTESTATE, 375);
+                            m_uiEndingTimer = 1000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 12:
+                            me->RemoveAura(SPELL_CHANNEL_KING);
+                            me->CastSpell(me, SPELL_BOOM_VISUAL, false);
+                            m_uiEndingTimer = 300;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 13:
+                            me->CastSpell(me, SPELL_SUMMON_BROKEN_FROSTMOURNE, false);
+                            m_uiEndingTimer = 3000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 14:
+                            me->CastSpell(me, 73017, false);
+                            m_uiEndingTimer = 1000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 15:
+                            DoScriptText(SAY_ENDING_6_KING, me);
+                            m_uiEndingTimer = 3000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 16:
+                            pFrostmourne = me->SummonCreature(27880, me->GetPositionX()+2, me->GetPositionY()+2, me->GetPositionZ(), 0, TEMPSUMMON_TIMED_OR_CORPSE_DESPAWN, 99999999);
+                            pFrostmourne->CastSpell(pFrostmourne, SPELL_BROKEN_FROSTMOURNE, false);
+                            pFrostmourne->CastSpell(pFrostmourne, SPELL_FROSTMOURNE_TRIGGER, false);
+                            pFrostmourne->GetMotionMaster()->MoveChase(me);
+                            me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_DISARMED);
+                            //pTirion->CastSpell(pTirion, SPELL_DISENGAGE, false);
+                            m_uiEndingTimer = 2000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 17:
+                            me->RemoveAllAuras();
+                            me->RemoveAura(SPELL_SUMMON_BROKEN_FROSTMOURNE);
+                            DoPlaySoundToSet(me, SOUND_ENDING_7_KING);
+                            me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 473);
+                            m_uiEndingTimer = 5000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 18:
+                            DoScriptText(SAY_ENDING_8_TIRION, pTirion);
+                            m_uiEndingTimer = 6000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 19:
+                            pFather = me->SummonCreature(CREAUTRE_MENETHIL, me->GetPositionX()+5, me->GetPositionY()+5, me->GetPositionZ(), 0, TEMPSUMMON_TIMED_OR_CORPSE_DESPAWN, 9999999);
+                            DoScriptText(SAY_ENDING_9_FATHER, pFather);
+                            pFather->CastSpell(pFather, SPELL_REVIVE);
+                            m_uiEndingTimer = 3000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 20:
+                            DoScriptText(SAY_ENDING_11_FATHER, pFather);
+                            //pFather->CastSpell(pFather, SPELL_REVIVE_VISUAL, false);
+                            m_uiEndingTimer = 6000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 21:
+                            DoScriptText(SAY_ENDING_10_TIRION, pTirion);
+                            m_uiEndingTimer = 5000;
+                            ++m_uiEndingPhase;
+                            break;
+                        case 22:
+                            DoScriptText(SAY_ENDING_12_KING, me);
+                            pTirion->SetReactState(REACT_AGGRESSIVE);
+                            pTirion->AI()->AttackStart(me);
+                            pFather->AI()->AttackStart(me);
+                            m_uiEndingTimer = 5000;
+                            ++m_uiEndingPhase;
+                            break;
+                        }
+                    } else m_uiEndingTimer -= uiDiff;
+                }
+
+                DoMeleeAttackIfReady();
+            }
+        private:
+            InstanceScript* pInstance;
+
+            uint8 m_uiEndingPhase;
+            uint8 m_uiPhase;
+
+            uint32 m_uiEndingTimer;
+            uint32 m_uiTirionSpawnTimer;
+            uint32 m_uiSummonShamblingHorrorTimer;
+            uint32 m_uiSummonDrudgeGhoulsTimer;
+            uint32 m_uiSummonShadowTrap;
+            uint32 m_uiInfestTimer;
+            uint32 m_uiNecroticPlagueTimer;
+            uint32 m_uiBerserkTimer;
+            uint32 m_uiSummonValkyrTimer;
+            uint32 m_uiSoulReaperTimer;
+            uint32 m_uiDefileTimer;
+            uint32 m_uiHarvestSoulTimer;
+            uint32 m_uiSummonVileSpiritTimer;
+            uint32 m_uiPainandSufferingTimer;
+            uint32 m_uiIcePulsSummonTimer;
+            uint32 m_uiSummonSpiritTimer;
+            uint32 m_uiRandomSpeechTimer;
+
+            bool TriggerSpawned;
+            bool bEnding;
+            bool bCast;
+
+            SummonList summons;
+
+        };
+
+        CreatureAI* GetAI(Creature* pCreature) const
+        {
+            return new boss_the_lich_kingAI(pCreature);
+        }
+};
+
+class npc_tirion_icc : public CreatureScript
+{
+    public:
+        npc_tirion_icc() : CreatureScript("npc_tirion_icc") { }
+
+        struct npc_tirion_iccAI : public ScriptedAI
+        {
+            npc_tirion_iccAI(Creature* pCreature) : ScriptedAI(pCreature)
+            {
+                pInstance = pCreature->GetInstanceScript();
+                pTirion = me;
+            }
+
+            void Reset()
+            {
+                m_uiIntroTimer = 1000;
+                m_uiIntroPhase = 1;
+
+                bIntro = false;
+
+                me->SetReactState(REACT_PASSIVE);
+                me->SetSpeed(MOVE_RUN, 1.8f);
+            }
+
+            void StartEvent()
+            {
+                bIntro = true;
+            }
+
+            void UpdateAI(const uint32 diff)
+            {
+                if(pInstance->GetData(DATA_LICH_KING_EVENT) != NOT_STARTED)
+                    me->RemoveFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
+                else
+                    me->SetFlag(UNIT_NPC_FLAGS, UNIT_NPC_FLAG_GOSSIP);
+
+                 if(!bIntro || !pInstance)
+                     return;
+
+                if(m_uiIntroTimer <= diff)
+                {
+                    switch(m_uiIntroPhase)
+                    {
+                    case 1:
+                        {
+                            pLichKing->SetStandState(UNIT_STAND_STATE_STAND);
+                            pLichKing->AddUnitMovementFlag(MOVEMENTFLAG_WALKING);
+                            pLichKing->SetSpeed(MOVE_WALK, 1.2f);
+                            pLichKing->GetMotionMaster()->MovePoint(0, MovePos[0]);
+                            me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 375);
+                            m_uiIntroTimer = 3000;
+                            ++m_uiIntroPhase;
+                        }
+                    break;
+                    case 2:
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 1);
+                        DoScriptText(SAY_INTRO_1_KING, pLichKing);
+                        m_uiIntroTimer = 14000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 3:
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
+                        DoScriptText(SAY_INTRO_2_TIRION, me);
+                        m_uiIntroTimer = 9000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 4:
+                        DoScriptText(SAY_INTRO_3_KING, pLichKing);
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 392);
+                        m_uiIntroTimer = 3000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 5:
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 397);
+                        m_uiIntroTimer = 2000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 6:
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
+                        m_uiIntroTimer = 18000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 7:
+                        me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 397);
+                        DoScriptText(SAY_INTRO_4_TIRION, me);
+                        m_uiIntroTimer = 1000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 8:
+                        me->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
+                        me->GetMotionMaster()->MovePoint(0, MovePos[3]);
+                        m_uiIntroTimer = 2000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 9:
+                        pLichKing->CastSpell(pTirion, SPELL_ICEBLOCK_TRIGGER, true);
+                        m_uiIntroTimer = 2000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 10:
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 1);
+                        DoScriptText(SAY_INTRO_5_KING, pLichKing);
+                        m_uiIntroTimer = 12000;
+                        ++m_uiIntroPhase;
+                        break;
+                    case 11:
+                        pLichKing->SetUInt32Value(UNIT_NPC_EMOTESTATE, 0);
+                        pLichKing->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+                        pLichKing->SetReactState(REACT_AGGRESSIVE);
+                        if(Unit* pTarget = SelectUnit(SELECT_TARGET_RANDOM, 1))
+                            me->AI()->AttackStart(pTarget);
+                        m_uiIntroTimer = 6000;
+                        ++m_uiIntroPhase;
+                        break;
+                    }
+                } else m_uiIntroTimer -= diff;
+            }
+        private:
+            InstanceScript* pInstance;
+
+            uint32 m_uiIntroTimer;
+            uint8 m_uiIntroPhase;
+
+            bool bIntro;
+        };
+
+        bool OnGossipHello(Player* pPlayer, Creature* pCreature)
+        {
+            pPlayer->ADD_GOSSIP_ITEM(GOSSIP_ICON_CHAT, GOSSIP_START_EVENT, GOSSIP_SENDER_MAIN, 999999);
+            pPlayer->SEND_GOSSIP_MENU(10600, pCreature->GetGUID());
+
+            return true;
+        }
+
+        bool OnGossipSelect(Player* pPlayer, Creature* pCreature, uint32 /*uiSender*/, uint32 uiAction)
+        {
+            if (uiAction == 999999)
+            {
+                CAST_AI(npc_tirion_icc::npc_tirion_iccAI, pCreature->AI())->StartEvent();
+                pPlayer->CLOSE_GOSSIP_MENU();
+            }
+            return true;
+        }
+
+        CreatureAI* GetAI(Creature* pCreature) const
+        {
+            return new npc_tirion_iccAI(pCreature);
+        }
+};
+
+class npc_valkyr_icc : public CreatureScript
+{
+    public:
+        npc_valkyr_icc() : CreatureScript("npc_valkyr_icc") { }
+
+        struct npc_valkyr_iccAI : public ScriptedAI
+        {
+            npc_valkyr_iccAI(Creature* pCreature) : ScriptedAI(pCreature), vehicle(pCreature->GetVehicleKit())
+            {
+                assert(vehicle);
+            }
+
+            void Reset()
+            {
+                me->SetFlying(true);
+                m_uiGrabTimer = 2000;
+                me->GetVehicleKit();
+                InVehicle = false;
+
+                if (me->GetMotionMaster()->GetCurrentMovementGeneratorType() == POINT_MOTION_TYPE)
+                    me->GetMotionMaster()->MovementExpired();
+            }
+
+            void EnterCombat(Unit* /*who*/) { }
+
+            void MovementInform(uint32 type, uint32 id)
+            {
+                if(type != POINT_MOTION_TYPE)
+                    return;
+
+                if(id == POINT_PLARFORM_END)
+                    vehicle->RemoveAllPassengers();
+            }
+
+            void UpdateAI(const uint32 uiDiff)
+            {
+                if (!UpdateVictim())
+                    return;
+
+                if (!InVehicle && m_uiGrabTimer < uiDiff)
+                {
+                    if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100.0f, true))
+                    {
+                        pTarget->EnterVehicle(vehicle);
+                        InVehicle = true;
+                        me->GetMotionMaster()->MovePoint(POINT_PLARFORM_END, MovePos[4]);
+                        DoCast(me, SPELL_WINGS_OF_THE_DAMNED);
+                        if (IsHeroic())
+                            DoCast(pTarget, SPELL_LIFE_SIPHON);
+                    }
+                    m_uiGrabTimer = 20000;
+                } else m_uiGrabTimer -= uiDiff;
+            }
+        private:
+            uint32 m_uiGrabTimer;
+            bool InVehicle;
+
+            Vehicle* vehicle;
+        };
+
+        CreatureAI* GetAI(Creature* pCreature) const
+        {
+            return new npc_valkyr_iccAI(pCreature);
+        }
+};
+
+class npc_vile_spirit_icc : public CreatureScript
+{
+    public:
+        npc_vile_spirit_icc() : CreatureScript("npc_vile_spirit_icc") { }
+
+        struct npc_vile_spirit_iccAI : public ScriptedAI
+        {
+            npc_vile_spirit_iccAI(Creature* pCreature) : ScriptedAI(pCreature) { }
+
+            void Reset()
+            {
+                m_uiMoveTimer = 15000;
+                DoCast(me, SPELL_VILE_SPIRIT_DISTANCE_CHECK);
+                bStartMove = false;
+                DoStartNoMovement(me->getVictim());
+            }
+
+            void UpdateAI(const uint32 uiDiff)
+            {
+                if (!bStartMove && m_uiMoveTimer < uiDiff)
+                {
+                    DoStartMovement(me->getVictim());
+                    DoCast(me, SPELL_VILE_SPIRIT_ACTIVE);
+                    bStartMove = true;
+                    if(Unit* pTarget = SelectTarget(SELECT_TARGET_RANDOM, 1, 100, true))
+                        me->AddThreat(pTarget, 100000.0f);
+                    m_uiMoveTimer = 15000;
+                } else m_uiMoveTimer -= uiDiff;
+            }
+        private:
+            uint32 m_uiShriekTimer;
+            bool bStartMove;
+            uint32 m_uiMoveTimer;
+        };
+
+        CreatureAI* GetAI(Creature* pCreature) const
+        {
+            return new npc_vile_spirit_iccAI(pCreature);
+        }
+};
+
+class spell_lich_king_necrotic_plague : public SpellScriptLoader
+{
+    public:
+        spell_lich_king_necrotic_plague() : SpellScriptLoader("spell_lich_king_necrotic_plague") { } //70338
+
+
+        class spell_lich_king_necrotic_plague_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_lich_king_necrotic_plague_AuraScript)
+
+            void ExtraEffect(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if(!aurApp->GetBase()->GetCaster())
+                    return;
+
+                if (InstanceScript* instance = aurApp->GetBase()->GetCaster()->GetInstanceScript())
+                {
+                    CAST_AI(boss_the_lich_king::boss_the_lich_kingAI, CAST_CRE(aurApp->GetBase()->GetCaster())->AI())->DoCast(SPELL_PLAGUE_SIPHON);
+                    aurApp->GetBase()->GetCaster()->CastSpell(aurApp->GetBase()->GetCaster(), SPELL_NECROTIC_PLAGUE_IMMUNITY, true);
+
+                if (Unit* target = aurApp->GetTarget())
+                    if (Aura* plague = target->AddAura(SPELL_NECROTIC_PLAGUE, target))
+                        plague->SetStackAmount(plague->GetStackAmount() + 1);
+
+                if(aurApp->GetBase()->GetStackAmount() >= 30)
+                    instance->SetData(DATA_BEEN_WAITING, FAIL);
+                }
+            }
+
+            void Register()
+            {
+                OnEffectRemove += AuraEffectRemoveFn(spell_lich_king_necrotic_plague_AuraScript::ExtraEffect, EFFECT_0, SPELL_AURA_PERIODIC_DAMAGE, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_lich_king_necrotic_plague_AuraScript();
+        }
+};
+
+class spell_lich_king_infection : public SpellScriptLoader
+{
+    public:
+        spell_lich_king_infection() : SpellScriptLoader("spell_lich_king_infection") { } //70541
+
+
+        class spell_lich_king_infection_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_lich_king_infection_AuraScript)
+
+            void OnPeriodic(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if (Unit* sick = aurApp->GetBase()->GetCaster())
+                    if(sick->isAlive() && sick->GetHealthPct() > 90)
+                        sick->RemoveAurasDueToSpell(SPELL_INFEST);
+            }
+
+            void Register()
+            {
+                OnEffectPeriodic += AuraEffectPeriodicFn(spell_lich_king_infection_AuraScript::OnPeriodic, EFFECT_0, SPELL_AURA_PERIODIC_DAMAGE);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_lich_king_infection_AuraScript();
+        }
+};
+
+class spell_lich_king_valkyr_summon : public SpellScriptLoader
+{
+    public:
+        spell_lich_king_valkyr_summon() : SpellScriptLoader("spell_lich_king_valkyr_summon") { } //74361
+
+
+        class spell_lich_king_valkyr_summon_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_lich_king_valkyr_summon_AuraScript);
+
+            void OnApply(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if (Unit* caster = aurApp->GetBase()->GetCaster())
+                {
+                    uint8 spawnMod = caster->GetMap()->GetSpawnMode();
+                    aurApp->GetBase()->SetDuration(spawnMod == 1 || spawnMod == 3 ? 3000 : 1000);
+                }
+            }
+
+            void HandleTriggerSpell(AuraEffect const* aurEff, AuraApplication const* aurApp)
+            {
+                PreventDefaultAction();
+                if (Unit* caster = aurApp->GetBase()->GetCaster())
+                {
+                    uint32 triggerSpellId = GetSpellProto()->EffectTriggerSpell[aurEff->GetEffIndex()];
+                    float x, y, z;
+                    caster->GetPosition(x, y, z);
+                    caster->CastSpell(x, y, z + 6, triggerSpellId, true, NULL, NULL, GetCasterGUID(), caster);
+                }
+            }
+
+            void Register()
+            {
+                OnEffectPeriodic += AuraEffectPeriodicFn(spell_lich_king_valkyr_summon_AuraScript::HandleTriggerSpell, EFFECT_0, SPELL_AURA_PERIODIC_TRIGGER_SPELL);
+                OnEffectApply += AuraEffectApplyFn(spell_lich_king_valkyr_summon_AuraScript::OnApply, EFFECT_0, SPELL_AURA_PERIODIC_TRIGGER_SPELL, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_lich_king_valkyr_summon_AuraScript();
+        }
+};
+
+class spell_lich_king_winter : public SpellScriptLoader
+{
+    public:
+        spell_lich_king_winter() : SpellScriptLoader("spell_lich_king_winter") { } //68981
+
+
+        class spell_lich_king_winter_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_lich_king_winter_AuraScript)
+
+            void OnApply(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if (InstanceScript* instance = aurApp->GetTarget()->GetInstanceScript())
+                    if (GameObject* floor = GameObject::GetGameObject((*aurApp->GetBase()->GetOwner()), instance->GetData64(DATA_PLATFORM)))
+                        if(floor->HasFlag(GAMEOBJECT_FLAGS, GO_FLAG_DAMAGED))
+                            floor->RemoveFlag(GAMEOBJECT_FLAGS, GO_FLAG_DAMAGED);
+            }
+
+            void OnRemove(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if (Unit* caster = aurApp->GetBase()->GetCaster())
+                {
+                    caster->CastSpell(caster, SPELL_QUAKE, true);
+                    DoScriptText(SAY_BROKEN_ARENA, caster);
+                }
+            }
+
+            void Register()
+            {
+                OnEffectRemove += AuraEffectRemoveFn(spell_lich_king_winter_AuraScript::OnRemove, EFFECT_0, SPELL_AURA_PERIODIC_TRIGGER_SPELL, AURA_EFFECT_HANDLE_REAL);
+                OnEffectApply += AuraEffectRemoveFn(spell_lich_king_winter_AuraScript::OnRemove, EFFECT_0, SPELL_AURA_PERIODIC_TRIGGER_SPELL, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_lich_king_winter_AuraScript();
+        }
+};
+
+class spell_lich_king_quake : public SpellScriptLoader
+{
+    public:
+        spell_lich_king_quake() : SpellScriptLoader("spell_lich_king_quake") { } //72262
+
+
+        class spell_lich_king_quake_AuraScript : public AuraScript
+        {
+            PrepareAuraScript(spell_lich_king_quake_AuraScript)
+
+            void OnRemove(AuraEffect const* aurEff, AuraApplication const* aurApp, AuraEffectHandleModes /*mode*/)
+            {
+                if(!aurApp->GetBase()->GetCaster())
+                    return;
+
+                if (InstanceScript* instance = aurApp->GetTarget()->GetInstanceScript())
+                {
+                    if (GameObject* floor = GameObject::GetGameObject((*aurApp->GetBase()->GetOwner()), instance->GetData64(DATA_PLATFORM)))
+                    {
+                        floor->SetFlag(GAMEOBJECT_FLAGS, GO_FLAG_DAMAGED);
+                        CAST_AI(boss_the_lich_king::boss_the_lich_kingAI, pLichKing->AI())->NextPhase();
+                    }
+                }
+            }
+
+            void Register()
+            {
+                OnEffectRemove += AuraEffectRemoveFn(spell_lich_king_quake_AuraScript::OnRemove, EFFECT_0, SPELL_AURA_DUMMY, AURA_EFFECT_HANDLE_REAL);
+            }
+        };
+
+        AuraScript* GetAuraScript() const
+        {
+            return new spell_lich_king_quake_AuraScript();
+        }
+};
+
+class spell_vile_spirit_distance_check : public SpellScriptLoader
+{
+    public:
+        spell_vile_spirit_distance_check() : SpellScriptLoader("spell_vile_spirit_distance_check") { }
+
+
+        class spell_vile_spirit_distance_check_SpellScript : public SpellScript
+        {
+            PrepareSpellScript(spell_vile_spirit_distance_check_SpellScript);
+
+
+            void HandleScript(SpellEffIndex /*effIndex*/)
+            {
+                if (!(GetHitUnit() && GetHitUnit()->isAlive()))
+                    return;
+
+                if(Unit* caster = GetCaster())
+                {
+                    caster->CastSpell(caster, SPELL_BURST, true);
+
+                    if (InstanceScript* instance = caster->GetInstanceScript())
+                        instance->SetData(DATA_NECK_DEEP, FAIL);
+                }
+            }
+
+            void Register()
+            {
+                OnEffect += SpellEffectFn(spell_vile_spirit_distance_check_SpellScript::HandleScript, EFFECT_0, SPELL_EFFECT_DUMMY);
+            }
+        };
+
+        SpellScript* GetSpellScript() const
+        {
+            return new spell_vile_spirit_distance_check_SpellScript();
+        }
+};
+
+class spell_ice_burst_distance_check : public SpellScriptLoader
+{
+    public:
+        spell_ice_burst_distance_check() : SpellScriptLoader("spell_ice_burst_distance_check") { }
+
+
+        class spell_ice_burst_distance_check_SpellScript : public SpellScript
+        {
+            PrepareSpellScript(spell_ice_burst_distance_check_SpellScript);
+
+
+            void HandleScript(SpellEffIndex /*effIndex*/)
+            {
+                if (!(GetHitUnit() && GetHitUnit()->isAlive()))
+                    return;
+
+                if(Unit* caster = GetCaster())
+                    caster->CastSpell(caster, SPELL_ICE_BURST, true);
+            }
+
+            void Register()
+            {
+                OnEffect += SpellEffectFn(spell_ice_burst_distance_check_SpellScript::HandleScript, EFFECT_0, SPELL_EFFECT_DUMMY);
+            }
+        };
+
+        SpellScript* GetSpellScript() const
+        {
+            return new spell_ice_burst_distance_check_SpellScript();
+        }
+};
+
+void AddSC_boss_lichking()
+{
+    new boss_the_lich_king();
+    new npc_tirion_icc();
+    new npc_valkyr_icc();
+    new npc_vile_spirit_icc();
+    new spell_lich_king_necrotic_plague();
+    new spell_lich_king_infection();
+    new spell_lich_king_valkyr_summon();
+    new spell_lich_king_winter();
+    new spell_vile_spirit_distance_check();
+    new spell_ice_burst_distance_check();
+    new spell_lich_king_quake();
+}
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/icecrown_citadel.h b/src/server/scripts/Northrend/IcecrownCitadel/icecrown_citadel.h
--- a/src/server/scripts/Northrend/IcecrownCitadel/icecrown_citadel.h
+++ b/src/server/scripts/Northrend/IcecrownCitadel/icecrown_citadel.h
@@ -32,14 +32,20 @@
 
 enum eAchievements
 {
-    ACHIEV_BONED_10                       = 4534,
-    ACHIEV_BONED_25                       = 4610,
-    AVHIEV_FULL_HOUSE_10                  = 4535,
-    AVHIEV_FULL_HOUSE_25                  = 4611,
-    ACHIEV_MESS_10                        = 4537,
-    ACHIEV_MESS_25                        = 4613,
-    ACHIEVMENT_ONCE_BITTEN_TWICE_SHY_10   = 4539,
-    ACHIEVMENT_ONCE_BITTEN_TWICE_SHY_25   = 4618
+    ACHIEV_BONED_10                             = 4534,
+    ACHIEV_BONED_25                             = 4610,
+    AVHIEV_FULL_HOUSE_10                        = 4535,
+    AVHIEV_FULL_HOUSE_25                        = 4611,
+    ACHIEV_MESS_10                              = 4537,
+    ACHIEV_MESS_25                              = 4613,
+    ACHIEVMENT_ONCE_BITTEN_TWICE_SHY_10         = 4539,
+    ACHIEVMENT_ONCE_BITTEN_TWICE_SHY_25         = 4618,
+    ACHIEV_ALL_YOU_CAN_EAT_10                   = 4580,
+    ACHIEV_ALL_YOU_CAN_EAT_25                   = 4620,
+    ACHIEV_BEEN_WAITING_A_LONG_TIME_FOR_THIS_10 = 4601,
+    ACHIEV_BEEN_WAITING_A_LONG_TIME_FOR_THIS_25 = 4621,
+    ACHIEV_NECK_DEEP_IN_VILE_10                 = 4581,
+    ACHIEV_NECK_DEEP_IN_VILE_25                 = 4622
 };
 
 enum ePutricideActions
@@ -91,6 +97,9 @@
     DATA_ANGLE,
     DATA_BONED,
     DATA_SPAWN,
+    DATA_ALL_YOU_CAN_EAT,
+    DATA_BEEN_WAITING,
+    DATA_NECK_DEEP,
     DATA_PLATFORM
 };
 
@@ -162,7 +171,7 @@
     CREATURE_VALKYR                  = 36609,
     CREATURE_DEFILE                  = 38757,
     CREATURE_RAGING_SPIRIT           = 36701,
-    CREATURE_TRIGGER                 = 30494
+    CREATURE_TRIGGER                 = 38667
 };
 
 enum eGameobjects
diff --git a/src/server/scripts/Northrend/IcecrownCitadel/instance_icecrown_citadel.cpp b/src/server/scripts/Northrend/IcecrownCitadel/instance_icecrown_citadel.cpp
--- a/src/server/scripts/Northrend/IcecrownCitadel/instance_icecrown_citadel.cpp
+++ b/src/server/scripts/Northrend/IcecrownCitadel/instance_icecrown_citadel.cpp
@@ -20,6 +20,13 @@
 
 #define MAX_ENCOUNTER      12
 
+const Position SpawnLoc[]=
+{
+    {4523.889f, 2486.907f, 280.249f, 3.155f}, //fly pos
+    {4407.439f, 2484.905f, 203.374f, 3.166f}, //land pos
+    {4671.521f, 2481.815f, 343.365f, 3.166f} //spawn pos
+};
+
 class instance_icecrown_citadel : public InstanceMapScript
 {
     public:
@@ -53,6 +60,9 @@
                 uiAngle                 = 0;
                 uiSpawn                 = 0;
                 uiBoned                 = 0;
+                uiAllYouCanEat          = 0;
+                uiBeenWaiting           = 0;
+                uiNeckDeep              = 0;
                 uiIceWall1              = 0;
                 uiIceWall2              = 0;
                 uiMarrowgarEntrance     = 0;
@@ -404,6 +414,9 @@
                     case DATA_ANGLE:                  return uiAngle;
                     case DATA_BONED:                  return uiBoned;
                     case DATA_SPAWN:                  return uiSpawn;
+                    case DATA_ALL_YOU_CAN_EAT:        return uiAllYouCanEat;
+                    case DATA_BEEN_WAITING:           return uiBeenWaiting;
+                    case DATA_NECK_DEEP:              return uiNeckDeep;
                     case DATA_PLATFORM:               return uiArthasPlatform;
                 }
                 return 0;
@@ -710,6 +723,11 @@
                         }
                         uiEncounter[10] = data;
                         break;
+                    case DATA_LICH_KING_EVENT:
+                        break;
+                    case DATA_SPAWN:
+                        if(data >= 2)
+                            Creature* sindragosa = instance->SummonCreature(CREATURE_SINDRAGOSA, SpawnLoc[2]);
                 }
 
                 if (data == DONE)
@@ -872,6 +890,9 @@
             uint8 uiDifficulty;
             uint8 uiBoned;
             uint8 uiSpawn;
+            uint8 uiAllYouCanEat;
+            uint8 uiBeenWaiting;
+            uint8 uiNeckDeep;
             uint64 uiAngle;
             uint32 uiEncounter[MAX_ENCOUNTER];
         };
